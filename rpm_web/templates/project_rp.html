{% extends "base_generic.html" %}


{% block mainmenu %}

<nav class="navbar navbar-expand navbar-dark bg-dark">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link"  href="{% url 'frontpage' %}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{% url 'projects_rp_load' -1%}">Projects</a>  <!--projects_rp_load tiene 1 argumento, el id del proyecto: -1 = carga el primero -->
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'config_prj'%}">Conf Projects</a> 
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'user_profile'%}">Profile</a>
          </li>
          <li class="nav-item">
            {% if user.is_authenticated %}
            <a class="nav-link" href="{% url 'logout'%}?next={{request.path}}">Logout</a>
            {% else %}
            <a class="nav-link" href="{% url 'login'%}?next={{request.path}}">Login</a>
            {% endif %}
          </li>
        </ul>
        <ul class="navbar-nav ml-auto justify-content-right">
            <li class="nav-item">
              <a class="nav-link" id="id_tutorial" href="#">Tutorial?</a>
            </li>
          </ul>
      </div>
    </div>
  </nav>
  
{% endblock %}

{% block content %}



<!-- Tabs selectoras de proyecto-->
<ul id="projects_tab" class="nav nav-tabs "  data-title="Project tabs" data-intro="Here are all the projects. In grey have your projects and in blue have the projects from  another users."  > 
    {% for prj in project_list %}
        <li class="nav-item" >
            <a href="{% url 'projects_rp_load'  prj.id %}" class="nav-link border border-primary border-bottom-0"  id="{{ prj.id }}" value="{{ prj.id }}" name="{{ prj.name }}" >{{ prj.name }}</a> 
        </li>
    {% endfor %}

    <!-- Proyectos de otros usuarios-->
    {% for prj in project_list_extra %}
    <li class="nav-item" style="background-color: rgb(127, 174, 235);">
        <a href="{% url 'projects_rp_load'  prj.id %}" class="nav-link border border-primary border-bottom-0"  id="{{ prj.id }}" value="{{ prj.id }}" name="{{ prj.name }}" >{{ prj.name }}</a> 
    </li>
    {% endfor %} 
     
    <!-- [+] for create new projects only if the user is in group "integradores"-->
    <li class="nav-item" >
        {% if flag_integradores %}
        <a href="{% url 'projects_rp_load' 0 %}" class="nav-link" id="id_create_project" value="0">
            <i class="bi bi-plus-square" ></i>
        </a>
        {%else%}
        <a  class="nav-link" id="id_create_project" value="0">
            <i class="bi bi-plus-square" ></i>
        </a>
        {% endif %}
    </li>
</ul>


<div id="id_total_body" style="visibility: hidden">

<!-- Datos del proyecto-->
<div class="card card-body" > <!-- card item-->
<div class="container-fluid " >
    <div class="row" >
        <div class="col-lg-10 p-0" data-title="Project info" data-intro="Here you have some project info.">
            <div class="row" >
                <div class="col-lg-2 input-group-text" id="id_prj_owner">Owner: </div>
                <div class="col-lg-3 input-group-text" id="id_prj_date_created">Date Created: {{date_created}}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-10 p-0" data-title="Project info" data-intro="You can change the project name and add some comments.">
                <div class="row" >
                    <div class="col-lg-2 input-group-text" >Project data</div>
                    <div class="col-lg-3 p-0">
                        <!-- <input type="hidden" class="form-control" name = "prjid" placeholder="Project Id" value="" id="id_prj_id_input">-->
                        <input type="text" class="form-control"  name = "prjname" placeholder="Project name..." value="{{prj_name}}" id="id_prj_name_input">
                    </div>
                    <div class="col-lg-3 p-0">
                        <input type="text" class="form-control"  name = "prjcomment" placeholder="Project comment..." value="{{prj_comment}}" id="id_prj_comment_input">
                    </div>
                    <div class="col-lg-2 p-0">
                        <button type="button" name="update" id=id_updateProjectMetadata  class="btn btn-success " onclick="updateProjectMetadata()" style="width:100%;" data-intro="Not forget to click Update!">Update</button>
                    </div>
                    <div class="col-lg-1 p-0">
                        <button type="button" name="remove" id="id_removeProject" class="btn btn-danger btn_remove" onclick="removeProject()" style="width:100%;" data-intro="And Be careful! you can remove all the project. ">X</button>
                    </div>
                    
                </div>
        </div>
        <div class="col-lg-2 p-0">
            <div class="row">
                <div class="col-lg-5 offset-lg-5 p-0">
                    <button type="button" name="pptGen"  class="btn btn-outline-warning" onclick="pptGenerator()" style="width:100%;">PPTx</button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>


<!-- Lista de Versiones-->
<div class="card card-body"> <!-- card item-->
<div class="container-fluid " >
    <div class="row">
        <div class="col-lg-10 p-0" >
            <div class="row" >
                <div class="col-lg-2 input-group-text" >Version list</div>
                <div class="col-lg-3 p-0">
                    <select class="form-control" id= "id_vers_list" name="versSelect" onchange="changesSelectVersion()" data-title="Project version" data-intro="Here you can select the version in wich you want work."> <!-- Campo Desplegable proyectos.-->
                        {% for vers in version_list %}
                          <option value="{{ vers.id }}" id="{{ vers.name }}" >{{ vers.name }} -- {{ vers.date }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 p-0">
                    <input type="text" class="form-control"  name = "versname" placeholder="Version name..." value="{{version_name}}" id="id_vers_name_input" size=2  data-intro="You can write a new name more appropriate.">
                </div>
                <div class="col-lg-2 p-0">
                    <button type="button" name="update" id="id_updateVersion"  class="btn btn-success " onclick="updateVersion()" style="width:100%;" data-intro="Please, click here after change someone name.">Update</button>
                </div>
                <div class="col-lg-1 p-0">
                    <button type="button" name="remove" id="id_removeVersion" class="btn btn-danger btn_remove" onclick="removeVersion()" style="width:100%;" data-intro="The X not need more info...">X</button>
                </div>
                <div class="col-lg-1 p-0">
                    <button type="button" name="new" id="id_newVersion" class="btn btn-primary " onclick="newVersion()" style="width:100%;" title="Create new version based on this" data-intro="And if you click here, a new version will be created. Will be a copy to the version selected (same ECUs, etc. but until this moment, both will be diferents and not connected. ).">New</button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>


<!-- Configuracion paint-->
<div class="card card-body"> <!-- card item-->
    <div class="container-fluid " >
        <div class="row">
            <div class="col-lg-12 p-0" >
                <div class="row" > <!--Date -->
                    <div class="col-lg-1 input-group-text" >Start</div>
                    <div class="col-lg-2 p-0">
                        <input type="date" class="form-control" id="id_date_ini" name="date" placeholder="DD/MM/YYY"  value={{date_ini}} onchange="updateDatesPrint()"/>
                    </div>
                    <div class="col-lg-1 input-group-text" >Status</div>
                    <div class="col-lg-2 p-0">
                        <input type="date" class="form-control" id="id_date_status" name="date" placeholder="DD/MM/YYY"  value={{date_status}} onchange="updateDatesPrint()"/>
                    </div>
                    <div class="col-lg-1 input-group-text" >End</div>
                    <div class="col-lg-2 p-0">
                        <input type="date" class="form-control" id="id_date_end" name="date" placeholder="DD/MM/YYY"  value={{date_end}} onchange="updateDatesPrint()"/>
                    </div>
                </div>

                <div class="row mt-1" > <!--CW -->
                    <div class="col-lg-1 input-group-text" >Start CW-Y</div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="0" step="1" id="id_cw_ini"  value={{cw_ini}}  onchange="updateWeeksPrint()" style="max-width:100%;" >
                    </div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="0" step="1" id="id_y_ini"  value={{y_ini}}  onchange="updateWeeksPrint()" style="max-width:100%;" >
                    </div>
                    <div class="col-lg-1 input-group-text" >Status CW-Y</div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="0" step="1" id="id_cw_status"  value={{cw_status}}  onchange="updateWeeksPrint()" style="max-width:100%;" >
                    </div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="0" step="1" id="id_y_status"  value={{y_status}}  onchange="updateWeeksPrint()" style="max-width:100%;" >
                    </div>
                    <div class="col-lg-1 input-group-text" >End CW-Y</div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="0" step="1" id="id_cw_end"  value={{cw_end}}  onchange="updateWeeksPrint()" style="max-width:100%;" >
                    </div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="0" step="1" id="id_y_end"  value={{y_end}}  onchange="updateWeeksPrint()" style="max-width:100%;" >
                    </div>
                </div>

                <div class="row mt-3" >
                    <div class="col-lg-2 input-group-text" >Factor weeks</div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="1"  id="id_factor_weeks" value={{factor_weeks}} onchange="updateDatesPrint()"  >
                    </div>
                    <div class="col-lg-2 input-group-text" >Max ECUs in Slide</div>
                    <div class="col-lg-1 p-0">
                        <input class="form-control" type="number" min="1" id="id_max_ecu_slide"  value={{max_ecu_slide}} onchange="updateDatesPrint()" >
                    </div>
                    <div class="col-lg-3 p-0">
                        <!--<button type="button" name="update"  class="btn btn-success " onclick="updateDatesPrint()"  style="width:100%;">Update</button>-->
                    </div>
                </div>
        </div>
    </div>
</div>
</div>


<!-- Lista de ECUs-->
<div class="card card-body"> <!-- card item-->
    <div class="container-fluid " >
        <div class="row">
            <div class="col-lg-12 p-0" >
                <div class="row" >
                        <a class="btn btn-primary" data-toggle="collapse" href="#collapseECUs" role="button" aria-expanded="false" aria-controls="collapseECUs"  style="width:100%;"> <!-- collapse control-->
                            <i class="bi bi-arrows-angle-expand"></i>
                        </a>
                </div>
            </div>
        </div>


    <div class="collapse" id="collapseECUs"> <!-- collapse item-->
        <form name="ecu_list" id="id_ecu_list"> {% csrf_token %} <!-- Abre form.-->
        <div class="row mt-3">
            <div class="col-lg-4 p-0">
                <div class="row" >
                    <div class="col-lg-3 offset-lg-0  p-0" >
                        <button type="button" name="add" id="add" class="btn btn-primary" style="width:100%;" title="Add new line">Add</button>
                    </div>
                    <div class="col-lg-3 p-0" >
                        <button type="button" id="id_enviareculist" class="btn btn-success" onclick="sendDataECUlist()" style="width:100%;" >Save</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 p-0">
                <div class="row" >
                    <div class="col-lg-2 offset-lg-10 p-0">
                        <button type="button" id="id_enviareculist" class="btn btn-warning" onclick="ImportECUlist()" style="width:100%;" title="Import from the other project" >Import</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row ">
            <div class="col-lg-12 p-0 text-center" >
                <table style="margin-bottom:5px; width:100%;" class="table table-responsive table-striped" id="dynamic_field_old">
                    <thead>
                        <tr >
                        <th >ID</th>
                        <th >ECU Name</th>
                        <th >ECU Dx</th>
                        <th >ECU Comment</th>
                        <th >Created by</th>
                        <th ></th>
                        </tr>
                    </thead>
                    <tbody id="id_ecu_table">
                        <!--Aqui añade lineas.-->
                    </tbody>
                </table> <!-- Cierra table.-->
            </div>
        </div>
        </form> <!-- Cierra form.-->
    </div>

</div>
</div>


<!-- Tabla entradas RP-->
<div class="card card-body"> <!-- card item-->
<div class="container-fluid " >
    <div class="row">
        <div class="col-lg-12 p-0" >
            <div class="row" >
                <div class="col-lg-2 p-0" >
                    <input type="text" class="form-control" placeholder="Search.." aria-label="Username" aria-describedby="basic-addon1" id="search_field"  maxlength="4" size="4">
                </div>
                <div class="col-lg-1 p-0" >
                    <button class="btn btn-outline-primary" type="button" id="button-addon1" onclick="addRow_RI()" style="width:100%;">+ row</button>
                </div>
                <div class="col-lg-1 p-0" >
                    <button class="btn btn-outline-danger" type="button" id="button-addon2" onclick="removeRow_RI()" style="width:100%;">- row</button>
                </div>
                <div class="col-lg-2  p-1 "style="border: 1px solid; ">
                <div class="form-check"  >
                    <input class="form-check-input" type="checkbox" value="" id="id_autosave" >
                    <label class="form-check-label" for="id_autosave" style="width:100%;">
                      Autosave
                    </label>
                  </div>
                </div>              
                <div class="col-lg-2 p-0 " >
                    <button type="button" class="btn btn-success"  onclick="sendDataReleaselist()" style="width:100%;">Save</button>
                </div>
                <div class="col-lg-3 ms-2" >
                    <div class="row" >
                        <div class="col-lg-6 p-0" >
                            <button type="button" class="btn btn-outline-warning"  onclick="exportDataReleaselist()" style="width:100%;">Export (csv)</button>
                        </div>
                        <div class="col-lg-6 p-0" >
                            <button type="button" class="btn btn-outline-warning"  onclick="importDataReleaselist()" style="width:100%;">Import (csv)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row" >
                <div class="col-lg-10 offset-lg-1 p-0  mt-2 text-center" >
                    <div style=" height:487px; overflow: hidden; " id = "ResultadoTabla" ></div> <!-- Tabla !!!. width: 805px-->
                    <!-- <div style=" overflow: hidden; width: 100%;" id = "ResultadoTabla" ></div> --><!-- Tabla !!!. width: 805px-->
                </div>

            </div>

            <!---
            <div class="row" >
                <div class="col-lg-12 p-0" >
                    <p id="id_info_log">Log:</p>
                </div>
            </div>
            -->

</div>
</div>
</div>
<style>
.nav {
  white-space: nowrap;
  flex-wrap: nowrap;
  max-width: 100%;
  overflow-x: scroll;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
    margin-top: 20px;
    padding: 0;
    list-style: none;
}

.nav li {
  display: inline-block
}
</style>




<script type="text/javascript">
      //Configuro ajax con el CSRFToken---------------------
      // using jQuery get csrftoken from your HTML
      var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

      function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
      }
      $.ajaxSetup({
          beforeSend: function (xhr, settings) {
              // if not safe, set csrftoken
              if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                  xhr.setRequestHeader("X-CSRFToken", csrftoken);
              }
          }
      });
      //-------------------------------------------------------


      var version_id = 0 //global 
      var global_control_v = 0//global

      var date_ini //global
      var date_status //global
      var date_end //global

      var factor_weeks //global
      var max_ecu_slide //global


    $(document).ready(function(){
        console.log("ready function")

        date_ini = "{{date_ini}}"
        date_status = "{{date_status}}"
        date_end = "{{date_end}}"

        factor_weeks = "{{factor_weeks}}"
        max_ecu_slide = "{{max_ecu_slide}}"

        //enable or disable buttons etc------
        console.log("flag_disabled:")
        console.log("{{flag_disabled}}")
        flag_disable = false
        if("{{flag_disabled}}" == "True"){
            flag_disable = true
        }
        document.getElementById("id_prj_name_input").disabled = flag_disable
        document.getElementById("id_prj_comment_input").disabled = flag_disable
        document.getElementById("id_updateProjectMetadata").disabled = flag_disable
        document.getElementById("id_removeProject").disabled = flag_disable
        document.getElementById("id_vers_name_input").disabled = flag_disable
        document.getElementById("id_updateVersion").disabled = flag_disable
        document.getElementById("id_removeVersion").disabled = flag_disable
        document.getElementById("id_newVersion").disabled = flag_disable

        get_project_owner()

        //---

        //listener---
        document.getElementById("id_create_project").addEventListener("click", function(){
            console.log("{{flag_integradores}}")
            if("{{flag_integradores}}" == 'False'){
                bootbox.alert({
                    closeButton: false,
                    message: "Only the users in the group 'integradores' can create new projects. If you need create a project, please write to: alexandre.filgueira@seat.es"
                });
            }   
        }); 

        document.getElementById("id_tutorial").addEventListener("click",function(event){
          console.log(event)
          introJs().start();
        },false);

        //----

        load_RI();

        //select tab
        // Select tab by name
        console.log("prj_id: ", "{{prj_id}}")
        console.log(self.location.pathname)
        var id_path_array = self.location.pathname.split('/');
        id_path = id_path_array[id_path_array.length-2]

        if (id_path != "{{prj_id}}"){
            console.log("reload!")
            self.location="../"+ "{{prj_id}}";
        }

        console.log( $('#projects_tab a[value="{{prj_id}}"]'))
        if($('#projects_tab a[value="{{prj_id}}"]').length>0){
            $('#projects_tab a[value="{{prj_id}}"]').tab('show') //if exist then select
        }
        else{
            $("#projects_tab a:first").tab('show'); // else show first tab
            //alert('Seleccionado id de project no existente en esta lista');
        }

        //update project data
        prj_tab = $('#projects_tab a[value="{{prj_id}}"]')
        console.log(prj_tab)
        for (var i = 0, element; element = prj_tab[i++];) {
            console.log(element)
            console.log(".name:",element.name)
            document.getElementById('id_prj_name_input').value = element.name
        }
        //document.getElementById('id_prj_id_input').value = "{{prj_id}}"

        console.log(".comment:","{{prj_comment}}")
        if("{{prj_comment}}" != ""){
            document.getElementById('id_prj_comment_input').value = "{{prj_comment}}"
        }

        //select the last version
        $("#id_vers_list option:last").attr("selected", "selected");
        v_selected = $("#id_vers_list option:last")
        vers_name = ""
        for (var i = 0, element; element = v_selected[i++];) {
            console.log(".e:",element)
            console.log(".value:",element.value)
            console.log(".name:",element.id)
            version_id = element.value
            vers_name = element.id
        }
        document.getElementById("id_vers_name_input").setAttribute('value',vers_name);

        
        update_data_project("{{prj_id}}",version_id);

        
        //add ecu list control
        var id_i_ecu
        $('#add').click(function(){  
            id_i_ecu++;
            //$('#id_ecu_table').append('<tr id="row'+i+'"><td style="width:  10%"><input type="text" name="id"  required="required" size="2" value = '+0+ ' disabled  ></td><td style="width:  40%"><input type="text" name="name"  placeholder="required" required="required" pattern="[A-Za-z0-9]{1,20}" size="10"></td><td style="width:  40%" ><input type="text" name="comment"  placeholder="ECU comment" size="10" ></td><td style="width:  10%"><button type="button" name="remove_ecu" id="'+i+'" class="btn btn-danger btn_remove">X</button></td></tr>');   
            //$('#id_ecu_table').append('<tr id="row'+i+'"><td><input type="text" name="id"  required="required" size="3" value = '+0+ ' disabled  ></td><td><input type="text" name="name"  placeholder="required" required="required" style= '+'width:20em'+'  maxlength="199"  ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:40em'+'  maxlength="199"   ></td><td><button type="button" name="remove_ecu" id="'+i+'" class="btn btn-danger btn_remove">X</button></td></tr>');   
            //$('#id_ecu_table').append('<tr id="row'+id_i_ecu+'"><td><input type="text" id="id_'+id_i_ecu+'" name="id"  required="required" size="3" style= '+'width:3em'+' value = '+0+ ' disabled  ></td><td><input type="text" name="name"  placeholder="ECU name (required)" required="required" style= '+'width:17em'+'  maxlength="199"  ></td><td><input type="text" name="dx"  placeholder="ECU Dx"style= '+'width:10em'+'  maxlength="49"  ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:20em'+'  maxlength="199"   ></td><td><button type="button" name="remove_ecu" id="'+id_i_ecu+'" class="btn btn-danger btn_remove">X</button></td></tr>');   
            $('#id_ecu_table').append('<tr id="row'+id_i_ecu+'"><td><input type="text" id="id_'+id_i_ecu+'" name="id"  required="required" size="3" style= '+'width:3em'+' value = '+0+ ' disabled  ></td><td><input type="text" name="name"  placeholder="ECU name (required)" required="required" style= '+'width:17em'+'  maxlength="199"  ></td><td><input type="text" name="dx"  placeholder="ECU Dx"style= '+'width:4em'+'  maxlength="49"  ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:15em'+'  maxlength="199"</td><td ><input type="text"  name="created_by_name"  placeholder="" style= '+'width:10em'+'  maxlength="199"  disabled >  </td><td><input type="text" id="id_created_by_'+id_i_ecu+'" name="created_by"  placeholder="" style= '+'width:0em'+'  maxlength="199" disabled hidden ></td><td><button type="button" name="remove_ecu" id="'+id_i_ecu+'" class="btn btn-danger btn_remove">X</button></td></tr>');   


            //document.getElementById("id_enviareculist").disabled = false
        });  


        $(document).on('click', '*[name="remove_ecu"]', function(){
            var button_id = $(this).attr("id");

            console.log("button_id:",button_id)
            //check if line is empty or not
            obj = document.getElementById("id_"+button_id)
            console.log("obj:",obj)
            console.log("obj.value:",obj.value)
            if(obj.value != 0){


                
                //check if created by = user_id or you are the project owner
                created_by = document.getElementById("id_created_by_"+button_id)
                console.log("created_by.value:",created_by.value)
                console.log("user_id:","{{ user.id }}")

                flag_disable = false
                if("{{flag_disabled}}" == "True"){
                    flag_disable = true
                }

                if((created_by.value == "{{ user.id }}") || (flag_disable == false)) {

                    bootbox.confirm({
                        closeButton: false,
                        title: "Remove ECU?",
                        message: "Si elimina esta ECU, eliminará todas las entradas asociadas",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            console.log('This was logged in the callback: ' + result);
                            if (result == true) {
                                $('#row'+button_id+'').remove()
                                sendDataECUlist() //update ecu_list
                            }
                        }
                    }).css({'background-color': '#f99', 'font-weight' : 'bold', color: '#F00', 'font-size': '2em', 'font-weight' : 'bold'} );
                }
                else{
                    bootbox.alert({
                    closeButton: false,
                    message: "You are not the owner for this ECU"
                });
                }
            }
            else{
                $('#row'+button_id+'').remove()
            }
        });  


    });

    //Project manager functions---------------------------------------------------

function get_project_owner(){
    console.log("get_project_owner()")
    prj_id = "{{prj_id}}"
    $.ajax({
                                    type: "POST",
                                    url: "{% url 'getprojectowner' %}"  ,
                                    
                                    name: "testname",
                                    data: JSON.stringify( { prj_id } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(resp){
                                        console.log("resp:" + resp)
                                        document.getElementById('id_prj_owner').innerHTML = 'Owner: ' + resp.prj_owner
                                    },
                                    failure: function(resp){console.log("Hay un error:" + resp);},
                            });

}


function updateProjectMetadata(){
    console.log("updateProjectMetadata()")

    prj_name = document.getElementById("id_prj_name_input").value
    prj_comment = document.getElementById("id_prj_comment_input").value
    prj_id = "{{prj_id}}"

    $.ajax({
                                    type: "POST",
                                    url: "{% url 'update_project_metadata' %}"  ,
                                    
                                    name: "testname",
                                    data: JSON.stringify( { prj_name, prj_comment,prj_id } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(respuesta){
                                        console.log("respuesta:" + respuesta)
                                    },
                                    failure: function(respuesta){console.log("Hay un error:" + respuesta);},
                            });

}

    function removeProject(){
        console.log("removeProject()")
        bootbox.confirm({
                closeButton: false,
                title: "Remove Project?",
                message: "¿Está seguro de que desea eliminar el proyecto?",
                buttons: {
                    confirm: {
                        label: 'Yes',
                        className: 'btn-danger'
                    },
                    cancel: {
                        label: 'No',
                        className: 'btn-success'
                    }
                },
                callback: function (result) {
                    console.log('callback: ' + result);
                    if (result == true) {
                        //eliminar
                        select_value = "{{prj_id}}"; //this is the ID project
                        $.ajax({
                                    type: "POST",
                                    url: "{% url 'remove_project' %}"  ,
                                    
                                    name: "testname",
                                    data: JSON.stringify( { select_value } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(respuesta){
                                        console.log("Eliminado ID:" + respuesta.id_removed); 
                                        //select first project in the list
                                        console.log("Selecciona ID:" + respuesta.id_first_prj); 
                                        //Update url with new id -> retrocede uno y añade id: http://127.0.0.1:8000/rpm_web/projects/rp/6/ -> http://127.0.0.1:8000/rpm_web/projects/rp/3/
                                        self.location="../"+respuesta.id_first_prj;
                                    },
                                    failure: function(respuesta){console.log("Hay un error:" + respuesta.d);},
                            });
          
                    }
                }
            }).css({'background-color': '#f99', 'font-weight' : 'bold', color: '#F00', 'font-size': '2em', 'font-weight' : 'bold'} );
    }

    
    //Version manager functions---------------------------------------------------
    function changesSelectVersion(){
        console.log("changesSelectVersion()")
        v_selected = document.getElementById("id_vers_list")
        vers_name = ""
        for (var i = 0, element; element = v_selected[i++];) {
            //console.log(".e:",element)
            //console.log(".value:",element.value)
            //console.log(".name:",element.id)
            //console.log(".s:",element.selected)
            if(element.selected == true){
                version_id = element.value
                vers_name = element.id
            }
        }
        console.log("vers_name->",vers_name)
        document.getElementById("id_vers_name_input").setAttribute('value',vers_name);
        global_control_v = 0
        selectVersion()
    }
    function updateVersion(){
        console.log("changesSelectVersion()")
        global_control_v = -1
        selectVersion()
    }
    function selectVersion(){
        console.log("selectVersion()")
        var version = document.getElementById("id_vers_list")
        console.log("version_id:",version.value)
        version_id = version.value
        new_version = global_control_v
        global_control_v = 0
        project_id =  "{{prj_id}}";
        version_name = document.getElementById("id_vers_name_input").value
        $.ajax({
                                    type: "POST",
                                    url: "{% url 'update_version_form' %}"  ,
                                    
                                    name: "testname",
                                    data: JSON.stringify( { version_id, new_version, project_id, version_name } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(respuesta){
                                        if(respuesta.reload == true){
                                            console.log("reload")
                                            self.location=self.location //Reload the page
                                        }
                                        else{
                                        console.log("Select version ID:" + respuesta.vers_id); 
                                        //Aquí recibir datos para las ecus
                                        //document.getElementById("id_enviareculist").disabled = false
                                        version_id = respuesta.vers_id //global
                                        update_data_project(project_id,respuesta.vers_id);
                                        }
                                    },
                                    failure: function(respuesta){console.log("Hay un error:" + respuesta.d);},
                            });
    }

    function newVersion(){
        console.log("newVersion()")
        var version = document.getElementById("id_vers_list")
        version_id = version.value
        new_version = 1
        project_id =  "{{prj_id}}";
        version_name = document.getElementById("id_vers_name_input").value
        $.ajax({
                                    type: "POST",
                                    url: "{% url 'update_version_form' %}"  ,
                                    
                                    name: "testname",
                                    data: JSON.stringify( { version_id, new_version, project_id, version_name } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(respuesta){
                                        console.log("Received:" + respuesta.flag_ok); 
                                        if(respuesta.reload == true){
                                            console.log("reload")
                                            self.location=self.location //Reload the page
                                        }
                                    },
                                    failure: function(respuesta){console.log("Hay un error:" + respuesta.d);},
                            });
    }
    

    
    function removeVersion(){
        console.log("removeVersion()")
        bootbox.confirm({
                closeButton: false,
                title: "Remove Version?",
                message: "¿Está seguro de que desea eliminar la versión?",
                buttons: {
                    confirm: {
                        label: 'Yes',
                        className: 'btn-danger'
                    },
                    cancel: {
                        label: 'No',
                        className: 'btn-success'
                    }
                },
                callback: function (result) {
                    console.log('callback: ' + result);
                    if (result == true) {
                        //eliminar
                        select_value = document.getElementById("id_vers_list").value
                        console.log("select_value:",select_value)
                        $.ajax({
                                    type: "POST",
                                    url: "{% url 'remove_version' %}"  ,
                                    name: "testname",
                                    data: JSON.stringify( { select_value } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(respuesta){
                                        console.log("Eliminado ID:" + respuesta.id_removed); 
                                        //select first project in the list
                                        //Update url with new id -> retrocede uno y añade id: http://127.0.0.1:8000/rpm_web/projects/rp/6/ -> http://127.0.0.1:8000/rpm_web/projects/rp/3/
                                        self.location=self.location
                                    },
                                    failure: function(respuesta){console.log("Hay un error:" + respuesta.d);},
                            });
          
                    }
                }
            }).css({'background-color': '#f99', 'font-weight' : 'bold', color: '#F00', 'font-size': '2em', 'font-weight' : 'bold'} );
    }
    
function update_data_project(prj_id, vers_id){
    console.log("update_data_project()")
    //console.log("prj_id: ",prj_id)
    //console.log("vers_id: ",vers_id)
                        $.ajax({
                                    type: "POST",
                                    url: "{% url 'updatedataproject'%}"  ,
                                    name: "testname",
                                    data: JSON.stringify( { prj_id , vers_id} ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(resp){
                                        console.log(resp.ecuList_id)
                                        console.log(resp.ecuList_name)
                                        console.log(resp.ecuList_comment)
                                        console.log(resp.ecuList_dx)
                                        //clean table
                                        $("#id_ecu_table tr").remove();  //remove all rows

                                        flag_first_time = true //test for load table R input

                                        load_ecu_list(resp.ecuList_id,resp.ecuList_name,resp.ecuList_comment,resp.ecuList_dx, resp.ecuList_created_by, resp.ecuList_created_by_name,)
                                    },
                                    failure: function(resp){console.log("Hay un error:" + resp.d);},
                            });
}


//ECU manager functions---------------------------------------------------
var flag_first_time = true //global

function load_ecu_list(id_list,name_list,comment_list, dx_list, created_by_list,created_by_name_list){
    console.log("load_ecu_list()")
    for (i = 0; i < id_list.length; i++) {
        var created_by_name = created_by_name_list[i];
        console.log("created_by_name: ",created_by_name)
        var created_by = created_by_list[i];
        console.log("created_by: ",created_by)
        var dx = dx_list[i];
        console.log("dx: ",dx)
        var comment = comment_list[i];
        console.log("comment: ",comment) // para espacios: value = '+'"commentario con espacios"'+'  -> value = "'+ comment +'"" 
        var name = name_list[i]; // value = "'+ name +'"" 
        console.log("name: ",name)
        id = id_list[i];
        console.log("id: ",id)
        if(id == ""){id=0;}
        //$('#id_ecu_table').append('<tr id="row'+i+'"><td style="width:  10%" ><input type="text" name="id"  required="required" size="2" value = '+id+ ' disabled  ></td><td style="width:  40%"><input type="text" name="name"  placeholder="required" required="required" pattern="[A-Za-z0-9]{1,20}" size="10" value = '+name+ '></td><td style="width:  40%" ><input type="text" name="comment"  placeholder="ECU comment" size="10" value = '+comment+'  ></td><td style="width:  10%"><button type="button" name="remove_ecu" id="'+i+'" class="btn btn-danger btn_remove">X</button></td></tr>');
        //$('#id_ecu_table').append('<tr id="row'+i+'"><td ><input type="text" name="id"  required="required" size="3" value = '+id+ ' disabled  ></td><td><input type="text" name="name"  placeholder="required" required="required"  style= '+'width:20em'+'  maxlength="199"   value = "'+name+ '" ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:40em'+'  maxlength="199"  value = "'+ comment +'""  > </td><td><button type="button" name="remove_ecu" id="'+i+'" class="btn btn-danger btn_remove">X</button></td></tr>');
        id_i_ecu = i
        //$('#id_ecu_table').append('<tr id="row'+i+'"><td ><input type="text" id="id_'+i+'" name="id"  required="required" size="6" style= '+'width:3em'+' value = '+id+ ' disabled  ></td><td><input type="text" name="name"  placeholder="required" required="required"  style= '+'width:17em'+'  maxlength="199"   value = "'+name+ '" ></td><td><input type="text" name="dx"  placeholder="ECU Dx"  style= '+'width:10em'+'  maxlength="49"   value = "'+dx+ '" ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:20em'+'  maxlength="199"  value = "'+ comment +'""  > </td><td><button type="button" name="remove_ecu" id="'+i+'" class="btn btn-danger btn_remove">X</button></td></tr>');
        $('#id_ecu_table').append('<tr id="row'+i+'"><td ><input type="text" id="id_'+i+'" name="id"  required="required" size="6" style= '+'width:3em'+' value = '+id+ ' disabled  ></td><td><input type="text" name="name"  placeholder="required" required="required"  style= '+'width:17em'+'  maxlength="199"   value = "'+name+ '" ></td><td><input type="text" name="dx"  placeholder="ECU Dx"  style= '+'width:4em'+'  maxlength="49"   value = "'+dx+ '" ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:15em'+'  maxlength="199"  value = "'+ comment +'""  ></td>  <td ><input type="text"  name="created_by_name"  placeholder="created_by" style= '+'width:10em'+'  maxlength="199"  value = "'+ created_by_name +'" " disabled >  </td><td><input type="text" id="id_created_by_'+i+'"  name="created_by"  placeholder="created_by" style= '+'width:0em'+'  maxlength="199"  value = "'+ created_by +'" " disabled hidden ></td><td><button type="button" name="remove_ecu" id="'+i+'" class="btn btn-danger btn_remove">X</button></td></tr>');

    }

    if(flag_first_time == true){
        flag_first_time = false
        sendDataECUlist();
    }
}


function sendDataECUlist(){
    console.log("sendDataECUlist")
            ecu_list = [];
            form  = document.getElementById('id_ecu_list');
            console.log("form:" ,form)
            
            var id;
            var name;
            var dx;
            var comment;
            var created_by;
            var list_name = []
            var flag_name_empty = false;
            for (var i = 0, element; element = form[i++];) {
                //console.log(element.name)
                if (element.name == "id"){
                    id = element.value
                }
                if (element.name == "name"){
                    name = element.value
                    if(element.value == ""){
                        flag_name_empty = true;
                        element.style.border = "1px solid red";
                    }
                    else{
                        element.style.border = "1px solid black";
                }
                }
                if (element.name == "dx"){
                    dx = element.value
                    //list_name.push(name)
                    //ecu_list.push({id:id,name:name,dx:dx,comment:comment}) //Formato correcto para JSON!!
                }
                if (element.name == "comment"){
                    comment = element.value
                    list_name.push(name)
                    //ecu_list.push({id:id,name:name,dx:dx,comment:comment}) //Formato correcto para JSON!!
                }
                if (element.name == "created_by"){
                    created_by = element.value
                    ecu_list.push({id:id,name:name,dx:dx,comment:comment,created_by:created_by}) //Formato correcto para JSON!!
                }
            };
            console.log(ecu_list)
            //check unique name
            flag_name_rep = false;
            flag_name_blank = false;
            var name_rep = []
            for (var i = 0; i < list_name.length; i++) {
                for (var j = i+1; j < list_name.length; j++) {
                    if(list_name[i] == ""){
                        flag_name_blank = true
                    }
                    if(list_name[i] == list_name[j]){
                        flag_name_rep = true;
                        name_rep.push(list_name[i])
                    }
                }
            } 
            console.log("flag_name_rep: ",flag_name_rep)
            
            if((flag_name_rep != true) && (flag_name_blank != true)){
                if(flag_name_empty != true){
                    console.log("SEND!")
                    $.ajax({  
                        url: "{% url 'update_ECU_list' %}", 
                        method:"POST",  
                        data: JSON.stringify( {
                            ecu_list,
                            version_id, //global
                        } ),
                        success: function(resp)
                        {  
                            
                            if(resp.flag_ok == true){
                                console.log("Envio correcto!");

                                document.getElementById("id_total_body").style.visibility = "visible" //make appear the document when have load all data
                            }
                            //console.log("{{ecuList_name}}")//no actualizado
                            //console.log(resp.ecuList_name);//actualizado

                            //clean table
                            $("#id_ecu_table tr").remove();  //remove all rows

                            //populate table
                            load_ecu_list(resp.ecuList_id,resp.ecuList_name,resp.ecuList_comment,resp.ecuList_dx, resp.ecuList_created_by, resp.ecuList_created_by_name,);
                        
                            //update ReleaseInput table
                            updateRinputs(resp);
                        }  
                    });
                }
            }
            else{
                //alert("We don´t accept 2 or more ecu names repeated: "+name_rep);
                bootbox.alert({
                    closeButton: false,
                    message: "We don´t accept 2 or more ecu names repeated or empty: "+name_rep,
                });
            }
    }

function ImportECUlist(){
    console.log("ImportECUlist()")
    //solicita lista proyectos del usuario
    $.ajax({  
                    url: "{% url 'get_prj_list_user' %}", 
                    method:"POST",  
                    data: JSON.stringify( {
                    } ),
                    success: function(resp)
                    {  
                        console.log("resp:",resp)

                        prj_list = []
                        //Generate prokject list for radio inputs
                        for(i=0;i<resp.prj_name_list.length;i++){
                            //console.log("name:",resp.prj_name_list[i])
                            if(resp.prj_id_list[i] != "{{prj_id}}"){ //no añade el project actual
                            prj_list.push({text: resp.prj_name_list[i], value: i,},)
                            }

                        }
                        console.log("prj_list:",prj_list)
                        //open dialog box for select project
                        bootbox.prompt({
                            closeButton: false,
                            title: "Select a project to import the ECU list",
                            message: ' <p>We will copy the last version project</p> <p>Please select an option below:</p>',
                            inputType: 'radio',
                            inputOptions: prj_list,
                            callback: function (result) {
                                console.log(result);
                                if(result != null){
                                    console.log("select prj:",result," name:",resp.prj_name_list[result]," id:",resp.prj_id_list[result])
                                    prj_id = resp.prj_id_list[result]
                                    $.ajax({  
                                        url: "{% url 'copy_ecu_list' %}", 
                                        method:"POST",  
                                        data: JSON.stringify( {
                                            prj_id,
                                            version_id,
                                        } ),
                                        success: function(resp)
                                        { 
                                            console.log("resp:",resp)
                                            if(resp.ok == true){
                                                //reload
                                                self.location="../"+ "{{prj_id}}";
                                            }
                                        }  
                                    });

                                }
                            }
                        });


                    }  
            });
}

//Table RP manager functions---------------------------------------------------
   //Release_inputs--------------------------------------------------------
    //Variables globales    
    var tblExcel;
    //variables para configuración usuario
        var column_sort_n = 0;
        var column_sort_dir = 'asc';
        var autosave = true;

    //Listeners
    var checkbox = document.querySelector("input[id=id_autosave]");
    //inicializa
    if (checkbox.checked) {
        console.log("Checkbox is checked..");
        autosave = true;
    } else {
        console.log("Checkbox is not checked..");
        autosave = false;
    }
    //añade listener
    checkbox.addEventListener('change', function() {
    if (this.checked) {
        console.log("Checkbox is checked..");
        autosave = true;
    } else {
        console.log("Checkbox is not checked..");
        autosave = false;
    }
    });


    var flag_after_change = true //flag for evite the relaunch afterchange edit automatic

    function load_RI(){
        console.log("load_RI()")
        var RelInList_id = "{{ RelInList_id }}".split(";");
        var RelInList_id_ecu = "{{ RelInList_id_ecu }}".split(";");
        var RelInList_id_type = "{{ RelInList_id_type }}".split(";");
        var RelInList_n_version = "{{ RelInList_n_version }}".split(";");
        var RelInList_date = "{{ RelInList_date }}".split(";");
        var RelInList_plan = "{{ RelInList_plan }}".split(";");
        var RelInList_id_plan = "{{ RelInList_id_plan }}".split(";");
        var RelInList_visual = "{{ RelInList_visual }}".split(";");
        var RelInList_dx = "{{ RelInList_dx }}".split(";");
        var RelInList_comment = "{{ RelInList_comment }}".split(";");
        var RelInList_marked1 = "{{ RelInList_marked1}}".split(";");
        var RelInList_marked2 = "{{ RelInList_marked2}}".split(";");
        var RelInList_marked3 = "{{ RelInList_marked3}}".split(";");

        var RelInList_created_by = "{{ RelInList_created_by}}".split(";");
        var RelInList_created_by_name = "{{ RelInList_created_by_name}}".split(";");
        var RelInList_date_created = "{{ RelInList_date_created}}".split(";");
        
        var RelInList_ecu_name = "{{ RelInList_ecu_name }}".split(";");
        var RelInList_type_name = "{{ RelInList_type_name }}".split(";");

        var type_list_id = "{{ type_list_id }}".split(";");
        var type_list_name = "{{ type_list_name }}".split(";");
        var type_list_comment = "{{ type_list_comment }}".split(";");

        var plan_list_id = "{{ plan_list_id }}".split(";");
        var plan_list_name = "{{ plan_list_name }}".split(";");
        var plan_list_comment = "{{ plan_list_comment }}".split(";");

        var ecuList_name = "{{ ecuList_name }}".split(";");
        var ecuList_comment = "{{ ecuList_comment }}".split(";");
        var ecuList_dx = "{{ ecuList_dx }}".split(";");
        var ecuList_id = "{{ ecuList_id }}".split(";");

        /*
        console.log(RelInList_id);
        console.log(RelInList_id_ecu);
        console.log(RelInList_id_type);
        console.log(RelInList_n_version);
        console.log(RelInList_date);
        console.log(RelInList_plan);
        console.log(RelInList_id_plan);
        console.log(RelInList_visual);
        console.log(RelInList_dx);
        console.log(RelInList_comment);

        console.log(RelInList_ecu_name);
        console.log(RelInList_type_name);
        */

        //console.log("ecuList_name: ",ecuList_name);
        //console.log("ecuList_dx: ",ecuList_dx);
        //console.log(ecuList_comment);
        //console.log(ecuList_id);



        console.log("plan_list_name: ",plan_list_name);


        //populate data
        var data_table = []
        for (i = 0; i < RelInList_id.length; i++) {
            // date to weeks
            console.log("RelInList_date[i]:",RelInList_date[i])
            date_week = ""
            data_table.push({
                "RelInList_id":RelInList_id[i],
                "RelInList_id_ecu":RelInList_id_ecu[i],
                "RelInList_id_type":RelInList_id_type[i],
                "RelInList_n_version":RelInList_n_version[i],
                "RelInList_date":RelInList_date[i],
                "RelInList_date_w":date_week,

                "RelInList_plan":RelInList_plan[i],
                "RelInList_id_plan":RelInList_id_plan[i],
                "RelInList_visual":RelInList_visual[i],
                "RelInList_dx":RelInList_dx[i],
                "RelInList_comment":RelInList_comment[i],
                "RelInList_marked1":RelInList_marked1[i],

                "RelInList_created_by":RelInList_created_by[i],
                "RelInList_created_by_name":RelInList_created_by_name[i],
                "RelInList_date_created":RelInList_date_created[i],

                "RelInList_ecu_name":RelInList_ecu_name[i],
                "RelInList_type_name":RelInList_type_name[i],
            })
        }

        console.log("data_table: ",data_table);

        searchFiled = document.getElementById('search_field');


        config_resultados = {
            data: data_table,
            //dataSchema: {ID: null, ecu_name: "XXX_name", type_version: type_version_array[0], n_version: "XXX", date_beantragt: today, plan: null, flag_visual: true, dx_ecu: "xx-xx", week: 1, comment: "test"},
            dataSchema: {RelInList_id: 0, RelInList_id_ecu: null, RelInList_dx: null, RelInList_ecu_name: null, RelInList_n_version: null, RelInList_date: null,RelInList_date_w: null,  RelInList_type_name: null, RelInList_plan: null, RelInList_visual: true, RelInList_comment: null, RelInList_marked1:null,RelInList_created_by:null,RelInList_created_by_name:null, RelInList_date_created:null,},
            //colHeaders:['ID','ecu_name', 'type_version', 'n_version', 'date_beantragt', 'plan', 'flag_visual', 'dx_ecu', 'week', 'comment'],
            colHeaders:['ID', 'id_ecu','Dx_ecu','ecu_name','n_version','date','date_week','type','plan','visual', 'comment', 'marked1', 'created_by','created_by_name', 'date_created'],
            columns:[
                /* Comented for evit the first load in false
                {data: "RelInList_id", type: 'numeric', readOnly: true, editor: false,allowEmpty:true },
                //{data: "ecu_name",allowEmpty:true },
                //{data: "ecu_name",type:'dropdown',source: ecu_name_list_array, allowEmptyboolean:true},
                //{data: "type_version",type:'dropdown',source: [type_version_array[0], type_version_array[1], type_version_array[2]],allowEmptyboolean:true},
                //{data: "type_version",type:'dropdown',source: type_version_array,allowEmptyboolean:true},
                {data: "RelInList_id_ecu", type: 'numeric', readOnly: true, editor: false,allowEmpty:true},
                {data: "RelInList_dx", readOnly: true, editor: false,allowEmpty:true},
                //{data: "RelInList_n_version",allowEmpty:true},
                {data: "RelInList_ecu_name",type:'dropdown',source: ecuList_name, strict:true, },
                //{data: "RelInList_n_version", allowEmpty:false},
                {data: "RelInList_n_version",allowEmpty:false, validator: function (value, callback) {
                    if (value === '' || value == null) {
                    callback(this.allowEmpty);
                    return;
                    }
                    callback(true);
                },
                },

                //{data: "RelInList_date",validator: Handsontable.validators.DateValidator, allowInvalid: true},
                {data: "RelInList_date",type:'date',allowEmpty:true},
                {data: "RelInList_type_name",type:'dropdown',source: type_list_name,  strict:true,},
                //{data: "RelInList_plan",allowEmpty:true},
                {data: "RelInList_plan",type:'dropdown',source: plan_list_name,  strict:true,},
                {data: "RelInList_visual",type: 'checkbox',allowEmpty:true},
                //{data: "RelInList_dx",allowEmpty:true},
                //{data: "week",type: 'numeric',allowEmpty:true},
                {data: "RelInList_comment",allowEmpty:true, validator: function (value, callback) {
                    if(value != null){
                        if (value.length > 200) {
                            alert('comment Must be 200 character or less. Extra characters will be removed');
                            this.instance.setDataAtCell(this.row, this.col, value.substring(0, 200), null);
                        }
                    }
                    callback(true);
                },
                },
                {data: "RelInList_marked1",type: 'checkbox',allowEmpty:true},
                */
            ],
            fillHandle: {
                direction: 'vertical',
                autoInsertRow: true //dejar si quiero que se añada una fila al arrastrar
            },
            rowHeaders:true,
            //fixedRowsTop: 2,
            height: 487,
            //height: '100%',
            width: '100%',//805, //ver: https://handsontable.com/docs/8.3.1/tutorial-grid-sizing.html
            //width: 2000,
            //height: 500,
            //overflow: 'hidden',
            preventOverflow: 'horizontal',
            //colWidths: [45, 55, 160, 200, 200, 65, 65,40,500],
            //autoColumnSize: {useHeaders: true},

            manualColumnResize: true,
            manualRowResize: true,
            contextMenu:true,
            manualRowMove: true,
            columnSorting: true,
            
            columnSorting: {
                initialConfig: {
                    column: column_sort_n,
                    sortOrder: column_sort_dir,
                }
            },
            
            search: true,
            licenseKey: 'non-commercial-and-evaluation',
            
            afterChange: function(changes,source){
                //console.log("afterChange");
                if(source != 'loadData'){ //Note: For performance reasons, the changes array is null for "loadData" source.
                    if(autosave){
                    sendDataReleaselist();
                    }
                }


                if(source == 'edit' && flag_after_change == true){
                    flag_after_change = false

                //first check if is valid
                tblExcel.validateCells((valid) => {
                if (valid) {
                    //$.each(changes, function(index, element) {
                    element = changes[0]
                    var row = element[0];
                    var col = element[1];
                    //console.log("col:",col)
                    //if change data celss
                    if(col == 'RelInList_date'){
                        //var oldVal = element[2];
                        var newVal = element[3];
                        var pos_c = 0
                        var i = 0
                        //get column for the RelInList_date
                        for(var key in data_table[0]) {
                            i++
                            if(key == 'RelInList_date_w'){
                                pos_c = i
                            }
                        }
                        //take data and convert to week
                        date_week = newVal
                        if((date_week != "") && (date_week != null)){
                            d_list = date_week.split("/")
                            d = new Date(Date.UTC(d_list[2], d_list[1]-1, d_list[0])); // the month is 0-indexed
                            d_m = moment(d);
                            w = d_m.format('WW') //ISO week
                            y = d_m.format('GGGG')
                            date_week = w + '-' + y
                        }
                        tblExcel.setDataAtCell(row,pos_c,date_week) //this launch a afterchange
                    }

                    //if change week celss
                    if(col == 'RelInList_date_w'){
                        //var oldVal = element[2];
                        var newVal = element[3];
                        var pos_c = 0
                        var i = 0
                        //get column for the RelInList_date
                        for(var key in data_table[0]) {
                            i++
                            if(key == 'RelInList_date'){
                                pos_c = i
                            }
                        }
                        //take week and convert to date
                        date = newVal
                        date_format = date
                        if((date != "") && (date != null)){

                            date = getDateOfISOWeek(newVal.split("-")[0],newVal.split("-")[1]) //week, year
                            console.log("date:",date)
                            date_format = formatDate2(date)
                            console.log("date_format:",date_format)
                        }
                        tblExcel.setDataAtCell(row,pos_c,date_format) //this launch a afterchange
                    }
                }})
                }
                
                else{
                    flag_after_change = true
                }
            

                


            },
            afterColumnSort:function(currentSortConfig,destinationSortConfigs){
                console.log("afterColumnSort");
                //console.log(currentSortConfig);
                //console.log(destinationSortConfigs);
                for (var el of destinationSortConfigs) {
                    //console.log(el["column"]);
                    column_sort_n = el["column"]
                    column_sort_dir = el["sortOrder"]
                    //console.log(column_sort_dir);
                }
                
            },
            beforeRemoveRow:function(index,amount){
                console.log("beforeRemoveRow index:",index," amount:",amount); //Visual index of starter row.
                //if return false. Don´t remove the row
                //search column "created_by"
                pos_col = 0
                for(i=0;i<tblExcel.countCols();i++){
                    //console.log("header:",tblExcel.getColHeader(i))
                    if(tblExcel.getColHeader(i) == 'created_by'){
                        pos_col = i
                    }
                }
                //get cell value
                //index = tblExcel.toPhysicalRow(index)
                console.log("toPhysicalRow:",index)

                cell = tblExcel.getDataAtCell(index,pos_col)
                console.log("cell:",cell)

                //check if the created_id = owner project id
                flag_disable = false
                if("{{flag_disabled}}" == "True"){
                    flag_disable = true
                }

                if(("{{ user.id }}" == cell) || (cell ==null) || (cell == "") || (flag_disable == false)){
                    return true
                }
                else{
                    bootbox.alert({
                    closeButton: false,
                    message: "This row have other owner. you can´t remove it.",
                    });
                    return false
                }

            },
            /*
            afterCreateRow: function(registrosModificados,accionesHandsontable){
                console.log("afterCreateRow");
                if(accionesHandsontable != 'loadData'){ //Note: For performance reasons, the changes array is null for "loadData" source.
                //sendDataReleaselist();
                //add_empty_last_row_Releaselist();
                }
            },
            afterRemoveRow: function(registrosModificados,accionesHandsontable){
                console.log("afterRemoveRow");
                if(accionesHandsontable != 'loadData'){ //Note: For performance reasons, the changes array is null for "loadData" source.
                sendDataReleaselist();
                add_empty_last_row_Releaselist();
                }
            },
            afterValidate: function(isValid, value, row, prop){
                if(!isValid){
                    console.log(row, tblExcel.propToCol(prop))
                }
            },
            */
            
        };

        //Add table for ResultadoTabla
        tblExcel = new Handsontable(document.getElementById('ResultadoTabla'),config_resultados);

        tblExcel.render();

        tblExcel.validateCells();//launch the validator after load the page

        Handsontable.dom.addEvent(searchFiled, 'keyup', function (event) {
            var search = tblExcel.getPlugin('search');
            var queryResult = search.query(this.value);

            console.log(queryResult);
            tblExcel.render();
        });
    }

    


        function updateRinputs(resp) {
                console.log("updateRinputs()")
                console.log("RelInList_id: ",resp.RelInList_id);
                //formato: resp.
                //ej: resp.ecuList_name

                var data_table = []
                for (i = 0; i < resp.RelInList_id.length; i++) {
                    // date to weeks
                    date_week = resp.RelInList_date[i]
                    if(date_week != ""){
                        d_list = date_week.split("/")
                        d = new Date(Date.UTC(d_list[2], d_list[1]-1, d_list[0])); // the month is 0-indexed
                        d_m = moment(d);
                        w = d_m.format('WW') //ISO week
                        y = d_m.format('GGGG')
                        date_week = w + '-' + y
                    }

                    data_table.push({
                        "RelInList_id":resp.RelInList_id[i],
                        "RelInList_id_ecu":resp.RelInList_id_ecu[i],
                        "RelInList_id_type":resp.RelInList_id_type[i],
                        "RelInList_n_version":resp.RelInList_n_version[i],
                        "RelInList_date":resp.RelInList_date[i],
                        "RelInList_date_w":date_week,

                        "RelInList_plan":resp.RelInList_plan[i],
                        "RelInList_id_plan":resp.RelInList_id_plan[i],
                        "RelInList_visual":resp.RelInList_visual[i],
                        "RelInList_dx":resp.RelInList_dx[i],
                        "RelInList_comment":resp.RelInList_comment[i],
                        "RelInList_marked1":resp.RelInList_marked1[i],
                        "RelInList_marked2":resp.RelInList_marked2[i],
                        "RelInList_marked3":resp.RelInList_marked3[i],

                        "RelInList_created_by":resp.RelInList_created_by[i],
                        "RelInList_created_by_name":resp.RelInList_created_by_name[i],
                        "RelInList_date_created":resp.RelInList_date_created[i],

                        "RelInList_ecu_name":resp.RelInList_ecu_name[i],
                        "RelInList_type_name":resp.RelInList_type_name[i],
                    })
                }
                console.log(resp.RelInList_id);
                console.log(resp.RelInList_id_ecu);
                console.log(resp.RelInList_id_type);

                console.log("data_table: ",data_table);
            
                //update table values
                tblExcel.updateSettings({
                data: data_table,
                //dataSchema: {RelInList_id: 0, RelInList_id_ecu: null, RelInList_ecu_name: null, RelInList_n_version: null, RelInList_date: null, RelInList_type_name: null, RelInList_plan: null, RelInList_visual: null, RelInList_comment: null},
                columns:[
                {data: "RelInList_id", type: 'numeric', readOnly: true, editor: false,allowEmpty:true },
                {data: "RelInList_id_ecu", type: 'numeric', readOnly: true, editor: false,allowEmpty:true},
                {data: "RelInList_dx", readOnly: true, editor: false,allowEmpty:true},
                //{data: "RelInList_ecu_name",type:'dropdown',source: resp.ecuList_name,strict:true, validator: emptyValidator},
                {data: "RelInList_ecu_name",type:'dropdown',source: resp.ecuList_name,strict:true, validator: function (value, callback) {
                    if (value == '' || value == null) {
                    //callback(this.allowEmpty);
                    callback(false);
                    return;
                    }
                    callback(true);
                    },
                },
                {data: "RelInList_n_version",allowEmpty:false, validator: function (value, callback) {
                    if (value == '' || value == null) {
                    //callback(this.allowEmpty);
                    callback(false);
                    return;
                    }
                    callback(true);
                },
                },
                {data: "RelInList_date",type:'date',allowEmpty:true,
                dateFormat: 'DD/MM/YYYY', // https://momentjs.com/docs/#/parsing/ + https://github.com/Pikaday/Pikaday + https://handsontable.com/docs/8.3.2/demo-date.html
                correctFormat: true,
                //defaultDate: '01/01/2020',
                datePickerConfig: {
                    // First day of the week (0: Sunday, 1: Monday, etc)
                    firstDay: 1,
                    //showWeekNumber: true, // show the ISO week number at the head of the row  -> Bug -> fixed in version 1.8.2 -> A can´t load it
                    numberOfMonths: 3,
                    disableDayFn: function(date) {
                    // Disable Sunday and Saturday
                    return date.getDay() === 0 || date.getDay() === 6;
                    }
                },
                },

                //date in weeks---
                {data: "RelInList_date_w",allowEmpty:true,
                    validator: function(value, callback) {
                        if((value == "") || (value == null)){
                            callback(true)
                        }
                        else{
                            if( (/^([0-9]|-){0,7}$/.test(value)) && (/[0-9](?=-)/.test(value)) && (/(?<=-)[0-9]/.test(value))){
                                val_list = value.split("-")
                                if(val_list.length == 2){ //2 grupos
                                    console.log(val_list[0].length)
                                    if((val_list[0].length == 2) && (val_list[1].length == 4)){
                                        callback(true)
                                    } else{
                                        callback(false)
                                    }
                                
                                } else{
                                    callback(false)
                                }
                            } else {
                                callback(false)
                            }
                        }
                    }
                },


                {data: "RelInList_type_name",type:'dropdown',source: resp.type_list_name, strict:true, validator: function (value, callback) {
                    if (value == '' || value == null) {
                    //callback(this.allowEmpty);
                    callback(false);
                    return;
                    }
                    callback(true);
                    },
                },
                //{data: "RelInList_plan",allowEmpty:true},
                {data: "RelInList_plan",type:'dropdown',source: resp.plan_list_name, strict:true, validator: function (value, callback) {
                    if (value == '' || value == null) {
                    //callback(this.allowEmpty);
                    callback(false);
                    return;
                    }
                    callback(true);
                    },
                },
                {data: "RelInList_visual",type: 'checkbox',allowEmpty:true},
                {data: "RelInList_comment",allowEmpty:true, validator: function (value, callback) {
                    if(value != null){
                        if (value.length > 200) {
                            alert('comment Must be 200 character or less. Extra characters will be removed');
                            this.instance.setDataAtCell(this.row, this.col, value.substring(0, 200), null);
                        }
                    }
                    callback(true);
                },
                },
                {data: "RelInList_marked1",type: 'checkbox',allowEmpty:true},
                {data: "RelInList_created_by",allowEmpty:true, readOnly: true,}, //Is hidden!!!!
                {data: "RelInList_created_by_name",allowEmpty:true, readOnly: true}, 
                {data: "RelInList_date_created",allowEmpty:true, readOnly: true}, 

                ],
                hiddenColumns: {
                    copyPasteEnabled: true,
                    indicators: false,
                    columns: [12]
                },

                columnSorting: {
                initialConfig: {
                    column: column_sort_n,
                    sortOrder: 'asc',
                    sortOrder: column_sort_dir,
                }
            },

                });

                //tblExcel.render();
                //Launch validator
                tblExcel.validateCells(); 

                //tblExcel.loadData(data_table);
            }


        function addRow_RI(){
            console.log("addRow_RI")
            tblExcel.alter('insert_row');
        }

        function removeRow_RI(){
            console.log("removeRow_RI")
            tblExcel.alter('remove_row');
        }

        /*
        function validate_table_propia(){
                //var all_data = tblExcel.getData()//all data table. Formato Array
                var all_data = tblExcel.getSourceData()//all data table. Formato JSON
                console.log("all_data: ",all_data);
                //console.log("all_data-0: ",all_data[all_data.length-1]);
                //revalidate if is empty
                var flag_empty = false
                var i = 0
                var info_log = "No puede dejar vacias las celdas: <p></p>"
                for (var el of all_data) {
                    f = tblExcel.toPhysicalRow(i)
                    v = tblExcel.toVisualRow(i)
                    
                    console.log("i: ",i," f: ",f," v: ",v);
                    v_1 = v + 1
                    i = i + 1;
                    
                    //console.log(el["RelInList_type_name"])
                    if((el["RelInList_ecu_name"] ==="") || (el["RelInList_ecu_name"] ===null)) {
                        flag_empty = true;
                        info_log = info_log + "Fila:" + v_1 + " columna: ecu_name <p></p>"
                        var cell = tblExcel.getCell(v,3)
                        cell.style.background = '#ff3300';
                    }
                    if((el["RelInList_n_version"] ==="") || (el["RelInList_n_version"] ===null)) {
                        flag_empty = true;
                        info_log = info_log + "Fila:" + v_1 + " columna: n_version <p></p>"
                        var cell = tblExcel.getCell(v,4)
                        cell.style.background = '#ff3300';
                    }
                    if((el["RelInList_type_name"] ==="") || (el["RelInList_type_name"] ===null)) {
                        flag_empty = true;
                        info_log = info_log + "Fila:" + v_1 + " columna: type <p></p>"
                        var cell = tblExcel.getCell(v,7)
                        cell.style.background = '#ff3300';
                    }
                    if((el["RelInList_plan"] ==="") || (el["RelInList_plan"] ===null)) {
                        flag_empty = true;
                        info_log = info_log + "Fila:" + v_1 + " columna: type <p></p>"
                        var cell = tblExcel.getCell(v,8)
                        cell.style.background = '#ff3300';
                    }
                }
                if(flag_empty == true){
                    document.getElementById("id_info_log").innerHTML = info_log
                }
                else{
                    document.getElementById("id_info_log").innerHTML = ""
                }
                return flag_empty
        }
        */

        //Validate and send (save) the table
        function sendDataReleaselist(){
            console.log("sendDataReleaselist()");

            //remove the last empty row
            //remove_empty_last_row_Releaselist();

            //Validate all cells and only pass if all are valids
            tblExcel.validateCells((valid) => {
            if (valid) {
                //is valid
                //flag_empty = validate_table_propia()
                //console.log("flag_empty: ",flag_empty)

                //if(flag_empty == false){
                    var all_data = tblExcel.getSourceData()
                    //implementar sistema que almacene orden de usuario (id_ecu visual) y reinserte las filas en el mismo al actualizar
                    id_v = version_id
                    $.ajax({
                                    type: "POST",
                                    url: "{% url 'update_Release_list' %}",
                                    name: "testname",
                                    //data: JSON.stringify({tblExcel:[fila]}),
                                    //data: JSON.stringify( { all_data } ),
                                    data: JSON.stringify( {
                                        all_data,
                                        id_v
                                    } ),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function(respuesta){
                                        console.log("Informacion actualizada:" + respuesta.RelInList_id);
                                        updateRinputs(respuesta)
                                    },
                                    failure: function(respuesta){console.log("Hay un error:" + respuesta.d);},

                            });
                    //}
            }
            else{
                //is invalid
                console.log("one or some cells are invalid!")
            }
            })
        }

function exportDataReleaselist(){
    console.log("exportDataReleaselist()")

    var exportPlugin1 = tblExcel.getPlugin('exportFile');

    exportPlugin1.downloadFile('csv', {
      bom: false,
      columnDelimiter: ',',
      columnHeaders: true,
      exportHiddenColumns: false,
      exportHiddenRows: false,
      fileExtension: 'csv',
      filename: 'rpm-CSV-file_[YYYY]-[MM]-[DD]',
      //range: [startRow, startColumn, endRow, endColumn]
      mimeType: 'text/csv',
      rowDelimiter: '\r\n',
      rowHeaders: false
    });
}

function import_csv(content_file){
            //console.log(content_file.split(",").length)
            //console.log(content_file.split(";").length)

            var data_csv = ""
            //if is posible that the user save the csv with ; or ,
            if(content_file.split(",").length > 4){
                console.log("separator (,)")
                data_csv = $.csv.toObjects(content_file,{'separator':','}); //need csv separet it by (,) -> https://github.com/typeiii/jquery-csv
            }
            if(content_file.split(";").length > 4){
                data_csv = $.csv.toObjects(content_file,{'separator':';'}); //need csv separet it by (,) -> https://github.com/typeiii/jquery-csv
            }
            if(data_csv == ""){
                bootbox.alert({
                    closeButton: false,
                    message: ".CSV file have invalid format (separator need , or ; ).",
                });
            }
            else{ //correct separator , or ;        
                console.log( "data_csv:",data_csv );

                //check heads
                flag_heads = true
                heads_needed = []
                if ("ecu_name" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("ecu_name")
                }
                if ("n_version" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("n_version")
                }
                if ("date" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("date")
                }
                if ("date_week" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("date_week")
                }
                if ("type" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("type")
                }
                if ("plan" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("plan")
                }
                if ("visual" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("visual")
                }
                if ("comment" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("comment")
                }
                if ("marked1" in data_csv[0]) {}
                else{
                    flag_heads = false
                    heads_needed.push("marked1")
                }
                if(flag_heads == false){
                    console.log("need heads:",heads_needed)
                    bootbox.alert({
                        closeButton: false,
                        message: ".CSV file need the rows: "+heads_needed,
                    });
                }
                else{

                    //load in the table
                    //data_csv_cop = data_csv
                    error_list_import = []
                    error_date_list_import = []

                    var flag_REimport = false
                    var ecu_list_csv = []
                    for(i=0;i<data_csv.length;i++){
                        //Find ECUs
                        ecu_list  = document.getElementById('id_ecu_list');
                            //check if need insert ECU
                            ecu_name_csv = data_csv[i].ecu_name
                            Dx_ecu_csv = ""
                            if ("Dx_ecu" in data_csv[0]) {Dx_ecu_csv = data_csv[i].Dx_ecu}
                                                        
                            var flag_ecu_in = false
                            for (var j = 0; j< ecu_list.length ; j++) {
                                //console.log(element.name)
                                element = ecu_list[j]
                                if (element.name == "name"){
                                    if(element.value == ecu_name_csv){
                                        flag_ecu_in = true
                                    }
                                }
                            }
                            if(flag_ecu_in == false){
                                console.log("Need ad ecu:",ecu_name_csv)
                                ecu_list_csv.push(ecu_name_csv)

                                //add line in ecu_list
                                id_i_ecu++
                                if(Dx_ecu_csv == ""){
                                    $('#id_ecu_table').append('<tr id="row'+id_i_ecu+'"><td><input type="text" id="id_'+id_i_ecu+'" name="id"  required="required" size="3" style= '+'width:3em'+' value = '+0+ ' disabled  ></td><td><input type="text" name="name"  placeholder="ECU name (required)" required="required" value='+ecu_name_csv+' style= '+'width:17em'+'  maxlength="199"  ></td><td><input type="text" name="dx"  placeholder="ECU Dx"style= '+'width:4em'+'  maxlength="49"  ></td><td ><input type="text" name="comment"  placeholder="ECU comment" style= '+'width:15em'+'  maxlength="199"   ></td><td ><input type="text"  name="created_by_name"  placeholder="" style= '+'width:10em'+'  maxlength="199"  disabled >  </td><td><input type="text" id="id_created_by_'+id_i_ecu+'" name="created_by"  placeholder="" style= '+'width:0em'+'  maxlength="199" disabled hidden ></td><td><button type="button" name="remove_ecu" id="'+id_i_ecu+'" class="btn btn-danger btn_remove">X</button></td></tr>');   
                                }
                                else{
                                    $('#id_ecu_table').append('<tr id="row'+id_i_ecu+'"><td><input type="text" id="id_'+id_i_ecu+'" name="id"  required="required" size="3" style= '+'width:3em'+' value = '+0+ ' disabled  ></td><td><input type="text" name="name"  placeholder="ECU name (required)" required="required" value='+ecu_name_csv+' style= '+'width:17em'+'  maxlength="199"  ></td><td><input type="text" name="dx" value='+Dx_ecu_csv+'  placeholder="ECU Dx"style= '+'width:4em'+'  maxlength="49"  ></td><td ><input type="text" name="comment"   placeholder="ECU comment" style= '+'width:15em'+'  maxlength="199"></td><td ><input type="text"  name="created_by_name"  placeholder="" style= '+'width:10em'+'  maxlength="199"  disabled >  </td><td><input type="text" id="id_created_by_'+id_i_ecu+'" name="created_by"  placeholder="" style= '+'width:0em'+'  maxlength="199" disabled hidden ></td><td><button type="button" name="remove_ecu" id="'+id_i_ecu+'" class="btn btn-danger btn_remove">X</button></td></tr>');   
                                }

                                //save ecu_list
                                //sendDataECUlist() //guarda antes en la tabla de que recargue post guardar la ecu_list asincronismo..
                                flag_REimport = true
                            }
                    }


                    if(flag_REimport == false){
                        for(i=0;i<data_csv.length;i++){

                            //adapt some posibles option for flags
                            if(data_csv[i].visual == ''){data_csv[i].visual  = 'False'}
                            if(data_csv[i].visual == '0'){data_csv[i].visual  = 'False'}
                            if(data_csv[i].visual == 'false'){data_csv[i].visual  = 'False'}
                            if(data_csv[i].visual == '1'){data_csv[i].visual  = 'True'}
                            if(data_csv[i].visual == 'true'){data_csv[i].visual  = 'True'}

                            if(data_csv[i].marked1 == ''){data_csv[i].marked1  = 'False'}
                            if(data_csv[i].marked1 == '0'){data_csv[i].marked1  = 'False'}
                            if(data_csv[i].marked1 == 'false'){data_csv[i].marked1  = 'False'}
                            if(data_csv[i].marked1 == '1'){data_csv[i].marked1  = 'True'}
                            if(data_csv[i].marked1 == 'true'){data_csv[i].marked1  = 'True'}


                        
                            //check date and date_week-------------
                            newVal = data_csv[i].date
                            //take data and convert to week
                            date_week = newVal
                            if((date_week != "") && (date_week != null)){
                                d_list = date_week.split("/")
                                d = new Date(Date.UTC(d_list[2], d_list[1]-1, d_list[0])); // the month is 0-indexed
                                d_m = moment(d);
                                w = d_m.format('WW') //ISO week
                                y = d_m.format('GGGG')
                                date_week = w + '-' + y
                            }
                            if(date_week != data_csv[i].date_week){
                                //hay diferencias entre date and date_week -> prevalece date_week
                                //take week and convert to date
                                newVal = data_csv[i].date_week
                                date = newVal
                                date_format = date
                                if((date != "") && (date != null)){

                                    date = getDateOfISOWeek(newVal.split("-")[0],newVal.split("-")[1]) //week, year
                                    date_format = formatDate2(date)
                                }
                                data_csv[i].date = date_format
                                error_date_list_import.push(i)
                            }

                            
                            if(check_row_import_csv(data_csv[i])){
                                //create new row
                                tblExcel.alter('insert_row');

                                //console.log("row:",tblExcel.countRows())
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 3, data_csv[i].ecu_name) //setDataAtCell(row, column, value, source)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 4, data_csv[i].n_version)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 5, data_csv[i].date)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 6, data_csv[i].date_week)
                                

                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 7, data_csv[i].type)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 8, data_csv[i].plan)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 9, data_csv[i].visual)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 10, data_csv[i].comment)
                                tblExcel.setDataAtCell(tblExcel.countRows()-1, 11, data_csv[i].marked1)

                            }
                            else{
                                error_list_import.push(i)
                            }
                        }
                    }
                    else
                    {
                        sendDataECUlist()

                        console.log("re import csv")
                        /*
                        bootbox.alert({
                            closeButton: false,
                            message: "Founded new ECUs that will be imported: "+ecu_list_csv ,
                        });
                        */

                        bootbox.alert({
                            closeButton: false,
                            title: "Remove Project?",
                            message: "Founded new ECUs that will be imported: "+ecu_list_csv,
                            callback: function (result) {
                                //console.log('callback: ' + result);
                                import_csv(content_file) //lo pongo aquí para retrasarlo y darle tiempo a recargar despues de hacer sendDataECUlist()
                            }
                        })
                    }

                    if(error_list_import.length>0){
                        bootbox.alert({
                            closeButton: false,
                            message: "Errors located in .CSV rows: "+error_list_import +" -> rows not imported!",
                        });
                    }
                    if(error_date_list_import.length>0){
                        bootbox.alert({
                            closeButton: false,
                            message: "Differences between date and date_week located in .CSV rows: "+error_date_list_import +" -> date was replaced by date_week ",
                        });
                    }
                }
            }
}

function importDataReleaselist(){
    console.log("importDataReleaselist()")

    //Generate a input element
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv'
    //input.setAttribute('accept', '.csv');

    input.onchange = e => {
        console.log("onchange")
        var file = e.target.files[0];
        console.log(file)
        //console.log(file.name)
        // setting up the reader
        var reader = new FileReader();
        reader.readAsText(file,'UTF-8');

        // here we tell the reader what to do when it's done reading...
        reader.onload = readerEvent => {
            var content_file = readerEvent.target.result; // this is the content!
            console.log( "content_file:",content_file);

            import_csv(content_file)


        }
    }

    input.click();
}


function check_row_import_csv(csv_line){
    var flag_ok = true

    if((csv_line.visual != 'True') && (csv_line.visual != 'False')){flag_ok = false}
    if((csv_line.marked1 != 'True') && (csv_line.marked1 != 'False')){flag_ok = false}

    return(flag_ok)
}

    //--------------------------------------------------------------------------------------
    //funciones generador PPTx--------------------------------------------------------------
    //--------------------------------------------------------------------------------------
    function pptGenerator(){
        console.log("pptGenerator()")

            //Validate all cells and only pass if all are valids
            console.log("tblExcel.rows:",tblExcel.countRows())
            if(tblExcel.countRows() > 0){
            tblExcel.validateCells((valid) => {
            if (valid) {
                //is valid
                //flag_empty = validate_table_propia() //removed 23/03/21
                //console.log("flag_empty: ",flag_empty)

                flag_empty = false //force for test  23/03/21
                if(flag_empty == false){

                    prj_id = "{{prj_id}}"; //this is the ID project
                    $.ajax({
                            type: "POST",
                            url: "{% url 'generatePptData' %}",
                            name: "testname",
                            data: JSON.stringify( {
                                prj_id,
                                version_id
                            } ),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function(resp){
                                console.log("Informacion actualizada:" + resp);
                                console.log("ecuList_name:" + resp.ecuList_name);
                                console.log("RelInList_ecu_name:" + resp.RelInList_ecu_name);
                                pptGenerator_admin(resp)
                            },
                            failure: function(resp){console.log("Hay un error:" + resp.d);},
                    });
                }
            }
            else{
                bootbox.alert({
                    closeButton: false,
                    message: "Someone cell in the data table is incorrect!"
                });
            }
        })
        }
        else{
            bootbox.alert({
                    closeButton: false,
                    message: "The data table have 0 rows!"
                });
        }
    }

    //var slide = []; //global
    function pptGenerator_admin(resp){
        console.log("pptGenerator_admin()")
        //Create ppt & conf--------------------
        //Create a new Presentation

        //variables globales
        let pptx = new PptxGenJS();
        var slide = [];

        var marked1_x = [];
        var marked1_y = [];
        //var cont_marked1 = 0
        
        //variables configurables by user
        //var MaxecuForSlide = 4 //variable configurable por user

        //var date_ini =  "{{date_ini}}"//moment("21-12-2020", 'DD-MM-YYYY'); //variable configurable por user //tiene que ser menor que date_status y date_end
        date_ini = moment(date_ini, 'YYYY-MM-DD'); 
        //var date_end = "{{date_end}}"//moment("04-06-2021", 'DD-MM-YYYY'); //variable configurable por user //tiene que ser mayor que date_status y date_ini
        date_end = moment(date_end, 'YYYY-MM-DD'); 
        //var date_status = "{{date_status}}"//moment("04-01-2021", 'DD-MM-YYYY') //variable configurable por user (aaaa/mm/dd)
        date_status = moment(date_status, 'YYYY-MM-DD'); 
        console.log("date_ini:",date_ini)
        console.log("date_status:",date_status)
        console.log("date_end:",date_end)

        //var factor_weeks = 1 //variable configurable por user

        //factor_weeks = "{{factor_weeks}}"
        //max_ecu_slide = "{{max_ecu_slide}}"

        //variables contadores
        var cont_ecu_slide = 0
        var cont_slides = 0
        var slideIndex = -1;

        //variables size slide
        var h_printZone = 5.88 //inches
        var w_printZone = 10.71 //inches
        var w_printZone2 = 8.26 

        //variables margenes
        var margin_t = 0.88
        var margin_b = 1
        var margin_r = 1
        var margin_l = 0.86
        var margin_t2 = 0.87
        var margin_b2 = 1
        var margin_r2 = 1
        var margin_l2 = 2.15

        //variables espacios
        var space_btwn_ecus = h_printZone / max_ecu_slide
        console.log("space_btwn_ecus:",space_btwn_ecus)

        //calcula semanas entre fechas a visualizar

        //var hoxe = new Date();

        //var diff = moment.duration(date_end.diff(date_ini));

        //console.log(diff.months() + " months, " + diff.weeks() + " weeks, " + diff.days()%7 + " days.");

        //console.log(Math.floor(diff.asWeeks()) + " weeks, " + diff.days()%7 + " days.");


        //var n_weeks = weeksBetween(date_ini, date_end); //variable n_weeks
        
        var n_weeks = myDiffWeeks(date_ini,date_end)
        console.log("weeksBetween: ",n_weeks)

        //calcula distancia entre semanas
        var w_weeks = w_printZone2 / n_weeks

        //m = moment(date_end, 'YYYY-MM-DD');
        //console.log(m.format('W'));

        //console.log('The current ISO week number is ' + new Date().getWeekNumber());


        //Add metadata
        pptx.author = 'Alexandre Filgueira Lago';
        pptx.company = 'SEAT.S.A.';
        pptx.revision = '01';
        pptx.subject = 'Release Plan Maker v2.0';
        pptx.title = 'Release Plan';
        //--------------------------------------

        //Slide sizes
        pptx.layout = 'LAYOUT_WIDE'; //13.3 x 7.5 inches

        //let image = new Image();
        //image.src = "/static/brand/logos_seat_cupra.png";
        //var logo_path = "/static/brand/logos_seat_cupra.png"
        var logo_path = resp.prj_logo_url
        if(logo_path == ""){
            logo_path = "/static/brand/logos_seat_cupra.png"
        }
        logo_path = "/static/brand/logos_seat_cupra.png" //force
        //var logo_path = "https://upload.wikimedia.org/wikipedia/en/a/a9/Example.jpg"

        //checkboxes conf prj
        title = ""
        if(resp.prj_flag_title == true){
            title =  resp.prj_title
        }

        date = ""
        if(resp.prj_flag_status_date == true){
            date =  "STATUS DATE: " + moment(date_status).format("DD-MM-YYYY")
        }

        if(resp.prj_flag_logo != true){
            logo_path =  ""
        }

        //Generate slide master--------------------------
        if((resp.prj_flag_head == true) && (resp.prj_flag_footer == true)){
            pptx.defineSlideMaster({
            title: "MASTER_SLIDE",
            background: { color: "FFFFFF" },
            //Head + Footer 
            objects: [
                //Head---- ->  ver que sacar del slidemaster
                { rect: { x: 0.46, y: 0.17, w: 12.39, h: 0.55, line: { color: "808080", width: 0.75  },}},
                { image: { x: 0.55, y: 0.18, w: 1.36, h: 0.55, path: logo_path } },
                { line: { x: 4.42, y: 0.17, w: 0, h: 0.55, line: { color: "808080", width: 0.75 } } },
                { line: { x: 8.89, y: 0.17, w: 0, h: 0.55, line: { color: "808080", width: 0.75 } } },
                { text: { text: "Created by \n"+resp.prj_created_by, options: { x: 0.70, y: 0.19, w: 3.73, h: 0.55,  align:'right', fontSize: 10.9, color: "808080" } } },//created by
                { text: { text: title, options: { x: 4.59, y: 0.23, w: 4.13, h: 0.28, align:'center', fontSize: 10.9,color: "000000" } } },//title
                { text: { text: date, options: { x: 8.92, y: 0.23, w: 2.99, h: 0.28,  align:'left', fontSize: 10.9, color: "000000"}}},//status date
                
                { text: { text: "Sheet", options: { x: 10.99, y: 0.46, w: 1.7, h: 0.27,  align:'right', fontSize: 10.9, color: "808080" } } },
                
                //Foot
                { rect: { x: 0.46, y: 6.82, w: 12.39, h: 0.50, line: { color: "808080", width: 0.75  },}},
            ],

            slideNumber : { x: 12.55, y: 0.46, w: 1.7, h: 0.27,  align:'left', fontSize: 10.9, color: "808080", },
        });
        }

        if((resp.prj_flag_head == true) && (resp.prj_flag_footer == false)){
            pptx.defineSlideMaster({
            title: "MASTER_SLIDE",
            background: { color: "FFFFFF" },
            //Head 
            objects: [
                //Head---- ->  ver que sacar del slidemaster
                { rect: { x: 0.46, y: 0.17, w: 12.39, h: 0.55, line: { color: "808080", width: 0.75  },}},
                { image: { x: 0.55, y: 0.18, w: 1.36, h: 0.55, path: logo_path } },
                { line: { x: 4.42, y: 0.17, w: 0, h: 0.55, line: { color: "808080", width: 0.75 } } },
                { line: { x: 8.89, y: 0.17, w: 0, h: 0.55, line: { color: "808080", width: 0.75 } } },
                { text: { text: "Created by \n"+resp.prj_created_by, options: { x: 0.70, y: 0.19, w: 3.73, h: 0.55,  align:'right', fontSize: 10.9, color: "808080" } } },//created by
                { text: { text: title, options: { x: 4.59, y: 0.23, w: 4.13, h: 0.28, align:'center', fontSize: 10.9,color: "000000" } } },//title
                { text: { text: date, options: { x: 8.92, y: 0.23, w: 2.99, h: 0.28,  align:'left', fontSize: 10.9, color: "000000"}}},//status date
                
                { text: { text: "Sheet", options: { x: 10.99, y: 0.46, w: 1.7, h: 0.27,  align:'right', fontSize: 10.9, color: "808080" } } },
            ],

            slideNumber : { x: 12.55, y: 0.46, w: 1.7, h: 0.27,  align:'left', fontSize: 10.9, color: "808080", },
        });
        }

        if((resp.prj_flag_head == false) && (resp.prj_flag_footer == true)){
            pptx.defineSlideMaster({
            title: "MASTER_SLIDE",
            background: { color: "FFFFFF" },
            //Footer 
            objects: [
                //Foot
                { rect: { x: 0.46, y: 6.82, w: 12.39, h: 0.50, line: { color: "808080", width: 0.75  },}},
            ],

            slideNumber : { x: 12.55, y: 0.46, w: 1.7, h: 0.27,  align:'left', fontSize: 10.9, color: "808080", },
        });
        }

        if((resp.prj_flag_head == false) && (resp.prj_flag_footer == false)){
            pptx.defineSlideMaster({
            title: "MASTER_SLIDE",
            background: { color: "FFFFFF" },
            slideNumber : { x: 12.55, y: 0.46, w: 1.7, h: 0.27,  align:'left', fontSize: 10.9, color: "808080", },
        });
        }


        //Calcula slides en función de max_ecu_slide--------------------
        /*
        console.log("resp.nECU:",resp.nECU)

        Nslides = Math.floor(resp.nECU / max_ecu_slide)
        if((resp.nECU % max_ecu_slide)>0){
            Nslides = Nslides + 1
        }
        console.log("Nslides:",Nslides)
        */
        var cont_jump = 0
        //Slide by slide (Not master)--------------------------
        //Recorre lista Ecus que se visualizan--------------
        for (i = 0; i < resp.ecuList_name.length; i++) {
            console.log("i",i)
            console.log("ecu:",resp.ecuList_name[i])
            console.log("max_ecu_slide:",max_ecu_slide)

            //checkea que haya alguna entrada para esta ECU dentro del tiempo
            var flag_entrada_in = false
            for(j=0;j<resp.RelInList_id_ecu.length;j++){
                if(resp.RelInList_id_ecu[j] == resp.ecuList_id[i]){
                    var date_ReIn = moment(resp.RelInList_date[j], 'DD-MM-YYYY')
                    //console.log("date_ReIn",date_ReIn)
                    if(date_ReIn.isBetween(date_ini, date_end)){
                        flag_entrada_in = true
                    }
                }
            }
            if(flag_entrada_in == false){
                //correct the problem when some ecu is out the time interval
                cont_jump = cont_jump + 1
            }

            console.log("flag_entrada_in:",flag_entrada_in)
            //if(flag_entrada_in == true){

            //checkea si toca añadir slide
            if ((((i+1-cont_jump) > (cont_slides * (max_ecu_slide))) )  || (cont_slides == 0))  { // (cont_slides == 0) asegura que aunque no haya entradas par alguna ecu, genere 1 slide y node error powerpoint
                cont_slides = cont_slides + 1
                console.log("Create slide")
                //var slide = pptx.addNewSlide();
                //Genera nueva slide y añade elementos comunes---------------------
                //Añade slide
                slideIndex = slideIndex + 1
                slide[slideIndex] = pptx.addSlide({ masterName: "MASTER_SLIDE" }); // addSlide Vs addNewSlide ¿?

                var s_week_mark = 0.28
                var cont_factor_weeks = 0
                //linea semanas
                for (s = 0; s < n_weeks; s++) {
                    var m_ini = moment(date_ini, 'YYYY-MM-DD').add(7*s, 'd');
                    var week_s = Number(m_ini.format('W'))
                    //console.log("week_s: ",week_s)
                    cont_factor_weeks = cont_factor_weeks + 1
                    //console.log("cont_factor_weeks: ",cont_factor_weeks)
                    if(cont_factor_weeks == factor_weeks){
                        //resp.RelInList_plan_fig1_color_1[j]
                        //slide[slideIndex].addText(week_s, {margin: 0, align:'center', fontSize: 10, color: "000000", bold:true, shape: pptx.ShapeType.ellipse, x: margin_l + margin_l2 + w_weeks * s, y: 1.01, w: s_week_mark, h: s_week_mark, fill: { color: "bbe0e3" }, line: { color: "7f7f7f", width: 0.50  } });
                        slide[slideIndex].addText(week_s, {margin: 0, align:'center', fontSize: 10, color: "000000", bold:true, shape: pptx.ShapeType.ellipse, x: margin_l + margin_l2 + w_weeks * s, y: 1.01, w:  resp.prj_week_s, h:  resp.prj_week_s, fill: { color: resp.prj_week_color }, line: { color: "7f7f7f", width: 0.50  } });
                    }
                    if(cont_factor_weeks == factor_weeks){
                        cont_factor_weeks = 0
                    }
                }

                //Paint zone ->  sacar del slidemaster
                slide[slideIndex].addShape(pptx.ShapeType.rect, {x: margin_l, y: margin_t, w: w_printZone, h: h_printZone, line: { color: "808080", width: 0.50  } });
                slide[slideIndex].addText("ECU-ReleasePlan", { x: 0.99, y: 0.83, w: 1.49, h: 0.28,  align:'center', fontSize: 10.9, color: "000000", bold:true   });

                //project name ->  sacar del slidemaster
                slide[slideIndex].addText(resp.prj_name, { x: 0.99, y: 1.1, w: 1.71, h: 0.22,  align:'center', fontSize: 7, color: "000000", bold:true, fill:"ffc000", line:{ pt:'0.75', color:'000000' }   });

                //Powered by..
                slide[slideIndex].addText("Powered by Alexandre Filgueira Lago [EE-32]", { x: 0.4, y: 7.3, w: 4, h: 0.27,  align:'left', fontSize: 8.0, color: "808080"    });

                //line actual week
                diff_actual_weeks = myDiffWeeks(date_ini,date_status)
                console.log("myDiffWeeks: ",diff_actual_weeks)
                //slide[slideIndex].addShape(pptx.ShapeType.rect, {x: margin_l + margin_l2 + w_weeks * diff_actual_weeks + s_week_mark/2 - 0.05/2, y: 1.01 + s_week_mark, w: 0.05, h: h_printZone  - s_week_mark*1.5, fill:"d9d9d9" });
                slide[slideIndex].addShape(pptx.ShapeType.rect, {x: margin_l + margin_l2 + w_weeks * diff_actual_weeks + s_week_mark/2 - 0.05/2, y: 1.01 + s_week_mark, w: resp.prj_marked1_w, h: h_printZone  - s_week_mark*1.5, fill:resp.prj_marked1_color });


                //Leyenda 2.0 --------------
                if(resp.prj_flag_legend == true){
                    var legend_y0 = 1.4
                    var legend_x0 = 0.34
                    var legend_h = 5.26
                    var legend_w = 1.05
                    var margin = 0.2
                    var margin2 = 0.1
                    
                    //console.log("resp.type_list:",resp.type_list)
                    //console.log("resp.plan_list:",resp.plan_list)
                    

                    cont_type = resp.type_list.length / 3 //3= name, type_name , s
                    cont_plan = (resp.plan_list.length /5) // 5 = name, color1, color2, color3, w
                    //console.log("cont_type:",cont_type)
                    //console.log("cont_plan:",cont_plan)


                    h_main = legend_h / cont_type - margin

                    //h_each = (h_main - margin) / cont_plan
                    h_each = h_main / (cont_plan+1) - margin2

                    if(h_main<0){h_main = 0}
                    if(h_each<0){h_each = 0}
                    if(h_each>0.2){h_each = 0.2}
                    //console.log("h_main:",h_main)
                    //console.log("h_each:",h_each)

                    for (t = 0; t < cont_type; t++) {
                        //add main blocks -> type
                        y_pos =legend_y0 + h_main * t + margin * (t)
                        
                        slide[slideIndex].addText(resp.type_list[3*t], {margin: 0, align:'center',valign:'top', fontSize: 10, color: "000000",bold:false, shape:pptx.ShapeType.roundRect, x: margin_l - 1.05/2 , y: y_pos , w: legend_w, h: h_main , fill:"ffffff",line:{ pt:'0.75', color:'000000' } });

                        shape_obj = resp.type_list[3*t + 1]
                        shape_list = shape_obj.split(".")
                        shape = shape_list[shape_list.length - 1]
                        //console.log("shape:",shape)

                        //add -> plans
                        for (p = 0; p < cont_plan; p++) {
                            y_pos2 = y_pos + 0.22 + h_each * p + margin2 * (p)

                            plan_name = resp.plan_list[5*p]
                            color_1 = resp.plan_list[5*p + 1]
                            color_2 = resp.plan_list[5*p + 2]
                            border_w = resp.plan_list[5*p + 4]

                            slide[slideIndex].addShape(shape, {x:margin_l - 1.05/2 +0.1, y:y_pos2, w: h_each, h: h_each, fill: { color: color_1 },line: { color: color_2, width: border_w},});
                            slide[slideIndex].addText(plan_name, { x:margin_l - 1.05/2 +0.1 + h_each, y:y_pos2, w: 4, h: h_each,  align:'left', fontSize: 10.0, color: "000000", bold:true  });
                        }
                    }
                }

                //slide[slideIndex].addShape(fig_form[0], {x:margin_l - 1.05/2 +0.1, y:2.09+delta_y, w: fig_form[1], h: s_mark, fill: { color: fig_form[2] },line: { color: fig_form[3], width: fig_form[4]},});
                //slide[slideIndex].addText("SW:", {margin: 0, align:'center',valign:'top', fontSize: 10, color: "000000",bold:false, shape:pptx.ShapeType.roundRect, x: margin_l - 1.05/2 , y: 1.82+delta_y , w: 1.05, h: 1.3 , fill:"ffffff",line:{ pt:'0.75', color:'000000' } });
                


                //clean array marked
                marked1_x = [];
                marked1_y = [];
                //cont_marked1 = 0

                cont_ecu_slide = 0 //resetea contador ecus por slide
            }
            //}
            //añade datos de cada ECU y sus entradas------------------
/*
            //checkea que haya alguna entrada para esta ECU dentro del tiempo
            var flag_entrada_in = false
            for(j=0;j<resp.RelInList_id_ecu.length;j++){
                if(resp.RelInList_id_ecu[j] == resp.ecuList_id[i]){
                    var date_ReIn = moment(resp.RelInList_date[j], 'DD-MM-YYYY')
                    if(date_ReIn.isBetween(date_ini, date_end)){
                        flag_entrada_in = true
                    }
                }
            }
*/
            if(flag_entrada_in == true){
                //añade linea ECU
                //console.log("Add ECU line")
                pos_y = margin_t + margin_t2 + cont_ecu_slide * space_btwn_ecus
                slide[slideIndex].addShape(pptx.shapes.LINE,{y: pos_y, x: margin_l + margin_l2, w: w_printZone2 , h: 0.0, line:{color: "808080",width: 1, },},);

                //Add ecu box and text
                ecu_name = resp.ecuList_name[i]
                if( resp.ecuList_dx[i] != ""){
                    ecu_name = ecu_name + ' - ' + resp.ecuList_dx[i]
                }
                slide[slideIndex].addText(ecu_name, { x: 1.58, y: pos_y - (0.22/2), w: 1.29, h: 0.22, align:'left', fontSize: 6, color: "000000",  line:{ pt:'0.75', color:'d9d9d9' }  });


                //Add ecu comments
                if(resp.ecuList_comment[i] != ""){
                    //comment_l = resp.ecuList_comment[i].length
                    //fontSize: 6 
                    //h_factor = Math.ceil( comment_l / 23);
                    var w = get_tex_width(resp.ecuList_comment[i])
                    console.log(w);
                    h_factor =  Math.ceil( w / 170) //170 es una aproximación de pixel a inch que mas o menos funciona
                    //autoFit + shrinkText no afecta hasta que el usuario realiza un cambio en el texto (manualmente)
                    slide[slideIndex].addText(resp.ecuList_comment[i], { x: 11.76, y: pos_y - (0.22/2), w: 1.15, h: 0.22*h_factor, align:'left', fontSize: 6, color: "000000",  line:{ pt:'0.75', color:'d9d9d9' },fill: { color: 'fdfdf0' },autoFit:true });
                }


                cont_ecu_slide = cont_ecu_slide + 1


                var input_ = new Array(3)
                for (var m = 0; m < input_.length; m++) {
                    input_[m] = new Array(n_weeks).fill("");
                }


                //Add Inputs for each ECU-------------------------------
                //busca en las entradas la ecu actual por id
                for(j=0;j<resp.RelInList_id_ecu.length;j++){
                    //console.log(resp.RelInList_id_ecu[j])
                    if(resp.RelInList_id_ecu[j] == resp.ecuList_id[i]){
                        //encontrada una entrada asociada a la ecu del bucle
                        console.log("Encontrada id_input:",resp.RelInList_id[j], ' Para ecu_id: ', resp.ecuList_id[i])
                        //añade entrada a la linea ECUactual
                        //....
                        var date_ReIn = moment(resp.RelInList_date[j], 'DD-MM-YYYY')
                        console.log("date_ini: ", date_ini , " date_end: ", date_end)
                        console.log("date_ReIn: ",date_ReIn)

                        if(date_ReIn.isBetween(date_ini, date_end)){
                            //si la fecha se encuentra entre las fechas ini and end
                            console.log("date IN")
                            
                            date_reIn = moment(resp.RelInList_date[j], 'DD-MM-YYYY');

                            diff_weeks = myDiffWeeks(date_ini, date_reIn)
                            console.log("myDiffWeeks: ",diff_weeks)

                            var week_s = Number(date_reIn.format('W'))

                            var pos_x = margin_l + margin_l2 + w_weeks * diff_weeks  + s_week_mark/2

                            //ellipse
                            //slide[slideIndex].addText(resp.RelInList_n_version[j], {margin: 0, align:'center', fontSize: 8, color: "000000", shape: pptx.ShapeType.ellipse, x: pos_x, y: pos_y- (s_week_mark/2), w: s_week_mark, h: s_week_mark, fill: { color: "bbe0e3" } });
                            //diamond
                            console.log(resp.RelInList_type_name[j])
                            //Esto puede ser modificable para que sea modificado por el usuario---

                            //reutilizo array

                            //fig_form = figure_format(pptx,resp.RelInList_type_name[j], resp.RelInList_plan[j],s_week_mark)
                            //fig_form[0] = resp.RelInList_type_fig1_name[j]
                            var fig_form = [5]
                            fig_form[0] = resp.RelInList_type_fig1_name[j].split(".") //need only the last word. Ex: pptx.ShapeType.diamond -> diamond
                            fig_form[0] = fig_form[0][fig_form[0].length - 1]

                            fig_form[1] = resp.RelInList_type_fig1_s[j]

                            fig_form[2] = resp.RelInList_plan_fig1_color_1[j] //fill color

                            fig_form[3] = resp.RelInList_plan_fig1_color_2[j] //border color

                            fig_form[4] = resp.RelInList_plan_fig1_border_w[j] //border w

                            //Posiciona entradas (centro-arriba-abajo) en función de si ya hay o no otra en la misma semana y linea ECU
                            var vers_name = "";
                            var pose = 0;
                            var flag_paint = true
                            //console.log("resp.type_list[0]:",resp.type_list[0])
                            switch(resp.RelInList_type_name[j]){
                                case resp.type_list[0]: //tradicionalmente SW
                                if(input_[0][diff_weeks] != ""){
                                    input_[0][diff_weeks] = input_[0][diff_weeks] + ' / ' + resp.RelInList_n_version[j]
                                    flag_paint = false
                                }
                                else{
                                    input_[0][diff_weeks] = resp.RelInList_n_version[j]
                                }
                                vers_name =  input_[0][diff_weeks]

                                //pose
                                if(input_[1][diff_weeks] != ""){
                                    if(input_[2][diff_weeks] != ""){pose = 3}
                                    else{pose = 2}}
                                else{
                                    if(input_[2][diff_weeks] != ""){pose = 2}
                                    else{pose = 1}}
                                //---

                                break;
                                case resp.type_list[3]: //tradicionalmente HW
                                if(input_[1][diff_weeks] != ""){
                                    input_[1][diff_weeks] = input_[1][diff_weeks] + ' / ' + resp.RelInList_n_version[j]
                                    flag_paint = false
                                }
                                else{
                                    input_[1][diff_weeks] = resp.RelInList_n_version[j]
                                }
                                vers_name =  input_[1][diff_weeks] 

                                //pose
                                if(input_[0][diff_weeks] != ""){
                                    if(input_[2][diff_weeks] != ""){pose = 3}
                                    else{pose = 2}}
                                else{
                                    if(input_[2][diff_weeks] != ""){pose = 2}
                                    else{pose = 1}}
                                //---

                                break;
                                case resp.type_list[6]: //tradicionalmente ZDC
                                if(input_[2][diff_weeks] != ""){
                                    input_[2][diff_weeks] = input_[2][diff_weeks] + ' / ' + resp.RelInList_n_version[j]
                                    flag_paint = false
                                }
                                else{
                                    input_[2][diff_weeks] = resp.RelInList_n_version[j]
                                }
                                vers_name =  input_[2][diff_weeks] 

                                //pose
                                if(input_[1][diff_weeks] != ""){
                                    if(input_[0][diff_weeks] != ""){pose = 3}
                                    else{pose = 2}}
                                else{
                                    if(input_[0][diff_weeks] != ""){pose = 2}
                                    else{pose = 1}}
                                //---
                                break;
                                default://como SW
                                if(input_[0][diff_weeks] != ""){
                                    input_[0][diff_weeks] = input_[0][diff_weeks] + ' / ' + resp.RelInList_n_version[j]
                                    flag_paint = false
                                }
                                else{
                                    input_[0][diff_weeks] = resp.RelInList_n_version[j]
                                }
                                vers_name =  input_[0][diff_weeks]
                                break;
                            }

                            //console.log("pose: ",pose)
                            var delta_y = 0
                            if(pose == 2){
                                delta_y = -s_week_mark- s_week_mark*0.1
                            }
                            if(pose == 3){
                                delta_y =  s_week_mark + s_week_mark*0.1
                            }

                            //Pinta figura---
                            //if(flag_paint == true){ //de momento lo pinta siempre y así el usuario elije cual desea
                            //añade comentario de la entrada como hyperlink
                            //var hyperlink = ""
                            var fpos_x =  pos_x - fig_form[1]/2
                            var fpos_y = pos_y- (s_week_mark/2) + delta_y
                            //checkea si hay marked
                            console.log("marked1:",resp.RelInList_marked1[j])

                            if(resp.RelInList_marked1[j] == "True"){
                                marked1_x.push(fpos_x + fig_form[1] /2)
                                marked1_y.push(fpos_y + s_week_mark /2)
                                //cont_marked1 = cont_marked1 + 1
                            }

                            if(resp.RelInList_comment[j] !=""){
                                slide[slideIndex].addText(week_s, {margin: 0, align:'center', fontSize: 8, color: "000000",bold:true,
                                shape: fig_form[0], x: fpos_x, y: fpos_y, w: fig_form[1], h: s_week_mark,
                                fill: { color: fig_form[2] },line: { color: fig_form[3], width: fig_form[4]  },hyperlink: { slide: slideIndex+1, tooltip: resp.RelInList_comment[j] } });
                            }
                            else{
                                slide[slideIndex].addText(week_s, {margin: 0, align:'center', fontSize: 8, color: "000000",bold:true,
                                shape: fig_form[0], x: fpos_x, y: fpos_y, w: fig_form[1], h: s_week_mark,
                                fill: { color: fig_form[2] },line: { color: fig_form[3], width: fig_form[4]  },});
                            }
                            //}

                            //version name (text)
                            //slide[slideIndex].addText(resp.RelInList_n_version[j], { x: pos_x + s_week_mark/2, y: pos_y, w: 1.29, h: 0.22, align:'left', fontSize: 7, color: "000000",bold:true,  });
                            slide[slideIndex].addText(vers_name, { x: pos_x- fig_form[1]/2 + s_week_mark/2, y: pos_y + delta_y, w: 1.29, h: 0.22, align:'left', fontSize: 7, color: "000000",bold:true,  });
                        }
                    }
                    //aqui es una vez por entrada
                    //checkea si hay 2 marked -> cuando solo hay una marked, no se marcará 
                    if(marked1_x.length == 2){
                        //puede crear linea
                        console.log("Create line marked")
                        var xm1_0 = 0
                        var xm1_1 = 0
                        var ym1_0 = 0
                        var ym1_1 = 0
                        var wm1 = 0
                        var hm1 = 0
                        var flag_flipV = false
                        
                        if(marked1_y[0] <= marked1_y[1])
                        {
                            ym1_0 = marked1_y[0]
                            xm1_0 = marked1_x[0]
                            xm1_1 = marked1_x[1]
                        }
                        else{
                            ym1_0 = marked1_y[1]
                            xm1_0 = marked1_x[1]
                            xm1_1 = marked1_x[0]
                        }

                        wm1 = Math.abs(marked1_x[0] - marked1_x[1]) - s_week_mark
                        hm1 = Math.abs(marked1_y[0] - marked1_y[1]) 

                        if(xm1_0 > xm1_1)//Check if need flip the shape
                        {
                            xm1_0 = xm1_0-wm1
                            flag_flipV = true
                        }

                        console.log("wm1:", wm1, " hm1:",hm1," xm1_0:",xm1_0, " ym1_0:",ym1_0)

                        //add line
                        //correct size
                        if(xm1_0 < xm1_1){
                            xm1_0 = xm1_0 + s_week_mark/2
                        }
                        else{
                            xm1_0 = xm1_0 - s_week_mark/2
                        }

                        if(xm1_0 <0){xm1_0 = 0}
                        if(ym1_0 <0){ym1_0 = 0}
                        if(wm1 <0){wm1 = 0}
                        if(hm1 <0){hm1 = 0}

                        console.log("wm1:", wm1, " hm1:",hm1," xm1_0:",xm1_0, " ym1_0:",ym1_0)
                        //slide[slideIndex].addShape(pptx.shapes.LINE,{ x: xm1_0, y: ym1_0, w:wm1 , h: hm1, rotate: (0),flipV:flag_flipV, line:{color: "dc143c",width: 1, },},);
                        slide[slideIndex].addShape(pptx.shapes.LINE,{ x: xm1_0, y: ym1_0, w:wm1 , h: hm1, rotate: (0),flipV:flag_flipV, line:{color: resp.prj_marked2_color,width: resp.prj_marked2_w, },},);
                        

                        //add markedS
                        xm1_0 = marked1_x[0] - s_week_mark / 2
                        xm1_1 = marked1_x[1] - s_week_mark / 2
                        ym1_0 = marked1_y[0] - s_week_mark / 2
                        ym1_1 = marked1_y[1] - s_week_mark / 2
                        slide[slideIndex].addShape(pptx.ShapeType.ellipse,{ x:xm1_0, y: ym1_0, w:s_week_mark , h: s_week_mark, line:{color: resp.prj_marked2_color,width: resp.prj_marked2_w, },},);
                        slide[slideIndex].addShape(pptx.ShapeType.ellipse,{ x:xm1_1, y: ym1_1, w:s_week_mark , h: s_week_mark, line:{color: resp.prj_marked2_color,width: resp.prj_marked2_w, },},);

                        //remove first element
                        marked1_x.shift();
                        marked1_y.shift();
                    }
                }
                //Aquí es una vez por ecu

            }
        }




        //Save pptx
        //........
        pptx.writeFile("Sample Presentation.pptx");

    }


    function get_tex_width(txt, font) {
        this.element = document.createElement('canvas');
        this.context = this.element.getContext("2d");
        this.context.font = font;
        w = this.context.measureText(txt).width

        console.log(window.devicePixelRatio)
        
        return w;
    }

    function figure_format(pptx,type, plan,w){
        var figure_type;
        var figure_w;
        switch(type){
            case "SW":
                figure_type =  pptx.ShapeType.diamond
                figure_w = w
            break;
            case "HW":
                figure_type =  pptx.ShapeType.diamond
                figure_w = w / 2
            break;
            case "ZDC":
                figure_type =  pptx.ShapeType.hexagon
                figure_w = w
            break;
            default:
                figure_type =  pptx.ShapeType.ellipse
                figure_w = w
            break;
        }
        //Selecciona color figura en función del plan
        var fill_color;
        var border_color;
        var w_border;
        switch(plan){
            case "vbv":
                fill_color = "00b0f0" //azul
                border_color = "000000" //negro
                w_border = 1.75 //Gruesa
            break;
            case "te.vbv":
                fill_color = "00b0f0" //azul
                border_color = "7f7f7f" //gris oscuro
                w_border = 0.75 //fina
            break;
            case "planned":
                fill_color = "d9d9d9" //gris
                border_color = "7f7f7f" //gris oscuro
                w_border = 0.75 //fina
            break;
            default:
                fill_color = "d9d9d9" //gris
                border_color = "ff0000" //rojo
                w_border = 1.75 //Gruesa
            break;
        }
        let output = [figure_type, figure_w, fill_color,border_color, w_border ];
        return(output)
    }

    function myDiffWeeks(d1, d2){
        console.log("d1: ",d1, " d2: ",d2)
        //var diff_actual_weeks = weeksBetween(d1, d2);
        //console.log("diff_actual_weeks: ",diff_actual_weeks)

        d1 = moment(d1).format("YYYY-MM-DD")
        d2 = moment(d2).format("YYYY-MM-DD");
        console.log("d1: ",d1, " d2: ",d2)

        var m_ini = moment(d1, 'YYYY-MM-DD')
        var week_ini = Number(m_ini.format('W'))
        console.log("week_ini: ",week_ini)

        var m_status = moment(d2, 'YYYY-MM-DD')
        var week_status = Number(m_status.format('W'))
        console.log("week_status: ",week_status)

        var diff_weeks = 0

        var d1_year = moment(d1).format('YYYY')
        var m_ini_last = moment(d1_year+'-12-31', 'YYYY-MM-DD')
        var week_ini_last = Number(m_ini_last.format('W'))
        console.log("week_ini_last: ",week_ini_last)

        var d2_year = moment(d2).format('YYYY')
        var m_status_last = moment(d2_year+'-12-31', 'YYYY-MM-DD')
        var week_status_last = Number(m_status_last.format('W'))
        console.log("week_status_last: ",week_status_last)

        if(d1_year < d2_year){
            week_ini = week_ini - week_ini_last
        }

        if(week_ini > week_ini_last){
            //estas en la primera semana iso (ej: 01/02/03- 01-21 -> week 53 pero 31/12/21 -> week 52)
            week_ini = 0
        }
        if(week_status > week_status_last){
            //estas en la primera semana iso (ej: 01/02/03- 01-21 -> week 53 pero 31/12/21 -> week 52)
            week_status = 0
        }
        diff_weeks = week_status - week_ini

        //console.log("diff_weeks: ",diff_weeks)
        return(diff_weeks)
    }

    function weeksBetween(d1, d2) {
        return Math.round((d2 - d1) / (7 * 24 * 60 * 60 * 1000));
    }

    Date.prototype.getWeekNumber = function(){
        var d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate()));
        var dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7)
    };


function formatDate(date) { //format date yyyy-mm-dd
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;

    return [year, month, day].join('-');
}

function formatDate2(date) { //format date yyyy-mm-dd
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;

    return [day, month, year].join('/');
}


Date.prototype.getWeek = function (dowOffset) {
/*getWeek() was developed by Nick Baicoianu at MeanFreePath: http://www.meanfreepath.com */

    dowOffset = typeof(dowOffset) == 'int' ? dowOffset : 0; //default dowOffset to zero
    var newYear = new Date(this.getFullYear(),0,1);
    var day = newYear.getDay() - dowOffset; //the day of week the year begins on
    day = (day >= 0 ? day : day + 7);
    var daynum = Math.floor((this.getTime() - newYear.getTime() - 
    (this.getTimezoneOffset()-newYear.getTimezoneOffset())*60000)/86400000) + 1;
    var weeknum;
    //if the year starts before the middle of a week
    if(day < 4) {
        weeknum = Math.floor((daynum+day-1)/7) + 1;
        if(weeknum > 52) {
            nYear = new Date(this.getFullYear() + 1,0,1);
            nday = nYear.getDay() - dowOffset;
            nday = nday >= 0 ? nday : nday + 7;
            /*if the next year starts before the middle of
              the week, it is week #1 of that year*/
            weeknum = nday < 4 ? 1 : 53;
        }
    }
    else {
        weeknum = Math.floor((daynum+day-1)/7);
    }
    if(weeknum == 0){weeknum = 53}//añadido por Alexandre
    return weeknum;
};

function getDateOfISOWeek(w, y) { //get date from week (ISO)
    var simple = new Date(y, 0, 1 + (w - 1) * 7);
    var dow = simple.getDay();
    var ISOweekStart = simple;
    if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    return ISOweekStart;
}



function updateWeeksPrint(){
        cw_ini = document.getElementById("id_cw_ini").value
        y_ini = document.getElementById("id_y_ini").value
        date = getDateOfISOWeek(cw_ini,y_ini)
        //console.log("date:",date)
        date_format = formatDate(date)
        //console.log("date_format:",date_format) //convert date to yyyy-mm-dd
        document.getElementById("id_date_ini").value = date_format //update date calendar

        cw_status = document.getElementById("id_cw_status").value
        y_status = document.getElementById("id_y_status").value
        date = getDateOfISOWeek(cw_status,y_status)
        date_format = formatDate(date)
        document.getElementById("id_date_status").value = date_format //update date calendar

        cw_end = document.getElementById("id_cw_end").value
        y_end= document.getElementById("id_y_end").value
        date = getDateOfISOWeek(cw_end,y_end)
        date_format = formatDate(date)
        document.getElementById("id_date_end").value = date_format //update date calendar

        updateDatesPrint()
}

    function updateDatesPrint(){
        date_ini = document.getElementById("id_date_ini").value
        date_status = document.getElementById("id_date_status").value
        date_end = document.getElementById("id_date_end").value
        console.log("date_ini:",date_ini)
        console.log("date_status:",date_status)
        console.log("date_end:",date_end)

        //update weeks
        date_ini_date = new Date(date_ini);
        //console.log("date_ini_date:",date_ini_date)
        week = date_ini_date.getWeek();
        //console.log("week:",week)
        document.getElementById("id_cw_ini").value = week
        year = date_ini.split("-")[0]
        //console.log("year:",year)
        document.getElementById("id_y_ini").value = year

        date_status_date = new Date(date_status);
        week = date_status_date.getWeek();
        document.getElementById("id_cw_status").value = week
        year = date_status.split("-")[0]
        document.getElementById("id_y_status").value = year

        date_end_date = new Date(date_end);
        week = date_end_date.getWeek();
        document.getElementById("id_cw_end").value = week
        year = date_end.split("-")[0]
        document.getElementById("id_y_end").value = year

        var flag_date_ok = true
        //checkea fechas
        if((date_ini > date_status) || (date_ini >= date_end)){
            document.getElementById("id_date_ini").style.backgroundColor = "red";
            document.getElementById("id_cw_ini").style.backgroundColor = "red";
            document.getElementById("id_y_ini").style.backgroundColor = "red";
            flag_date_ok = false
        }
        else{
            document.getElementById("id_date_ini").style.backgroundColor = "white";
            document.getElementById("id_cw_ini").style.backgroundColor = "white";
            document.getElementById("id_y_ini").style.backgroundColor = "white";
        }
        if((date_end < date_status) || (date_end <= date_ini)){
            document.getElementById("id_date_end").style.backgroundColor = "red";
            document.getElementById("id_cw_end").style.backgroundColor = "red";
            document.getElementById("id_y_end").style.backgroundColor = "red";
            flag_date_ok = false
        }
        else{
            document.getElementById("id_date_end").style.backgroundColor = "white";
            document.getElementById("id_cw_end").style.backgroundColor = "white"; 
            document.getElementById("id_y_end").style.backgroundColor = "white"; 
        }
        if((date_ini > date_status) || (date_status > date_end)){
            document.getElementById("id_date_status").style.backgroundColor = "red";
            document.getElementById("id_cw_status").style.backgroundColor = "red";
            document.getElementById("id_y_status").style.backgroundColor = "red";
            flag_date_ok = false
        }
        else{
            document.getElementById("id_date_status").style.backgroundColor = "white";
            document.getElementById("id_cw_status").style.backgroundColor = "white";
            document.getElementById("id_y_status").style.backgroundColor = "white";  
        }

        factor_weeks = document.getElementById("id_factor_weeks").value
        max_ecu_slide = document.getElementById("id_max_ecu_slide").value

        if(factor_weeks<1){
            document.getElementById("id_factor_weeks").style.backgroundColor = "red";
            flag_date_ok = false
        }
        else{
            document.getElementById("id_factor_weeks").style.backgroundColor = "white";
        }
        if(max_ecu_slide<1){
            document.getElementById("id_max_ecu_slide").style.backgroundColor = "red";
            flag_date_ok = false
        }
        else{
            document.getElementById("id_max_ecu_slide").style.backgroundColor = "white";
        }

        if(flag_date_ok == true){
            //send values
            factor_weeks = document.getElementById("id_factor_weeks").value
            max_ecu_slide = document.getElementById("id_max_ecu_slide").value


            prj_id = "{{prj_id}}"; //this is the ID project

            //only update if the user is the owner project
            flag_disable = false
            if("{{flag_disabled}}" == "True"){
                flag_disable = true
            }
            if(flag_disable == false){
            $.ajax({
                    type: "POST",
                    url: "{% url 'updatedatevalues' %}",
                    name: "testname",
                    data: JSON.stringify( {
                        prj_id,
                        date_ini,
                        date_status,
                        date_end,
                        factor_weeks,
                        max_ecu_slide,
                    } ),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(resp){
                        console.log("Informacion actualizada:" + resp.ok);
                        date_ini = resp.date_ini
                        date_status = resp.date_status
                        date_end = resp.date_end
                        factor_weeks = resp.factor_weeks
                        max_ecu_slide = resp.max_ecu_slide
                    },
                    failure: function(resp){console.log("Hay un error:" + resp.d);},
            });
            }
        }

    }

    //scrollbar test----



</script>

{% endblock %}